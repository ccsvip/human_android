# 实现完整的国际化系统 - 2025-10-02

## 问题描述
需要在主界面添加国际化选项，支持中文和英文切换，并实现真正的全应用国际化。

## 解决方案

### 1. 国际化架构设计

#### 1.1 核心组件
- **LanguageManager**: 语言管理工具类（单例模式）
- **国际化资源文件**: 多语言strings.xml
- **WebView国际化**: JavaScript实现的i18n系统
- **BaseActivity增强**: 自动应用语言设置

#### 1.2 支持的语言
- 中文（zh）
- 英文（en）
- 可扩展其他语言

### 2. 实现细节

#### 2.1 语言管理器（LanguageManager）
**文件位置**: `duix-sdk/src/main/java/ai/guiji/duix/sdk/i18n/LanguageManager.kt`

**核心功能**:
- 单例模式管理全局语言设置
- 支持语言枚举（CHINESE, ENGLISH）
- 持久化存储用户语言选择（SharedPreferences）
- 提供语言切换API
- 观察者模式通知语言变更
- 自动检测系统默认语言

**关键方法**:
```kotlin
getCurrentLanguage(context): Language  // 获取当前语言
setLanguage(context, language)         // 设置语言
applyLanguage(context, language)       // 应用语言到Context
getSupportedLanguages()                // 获取支持的语言列表
```

#### 2.2 Android国际化资源

**资源文件结构**:
```
test/src/main/res/
├── values/strings.xml          # 默认（英文）
├── values-en/strings.xml       # 英文
└── values-zh-rCN/strings.xml   # 简体中文
```

**包含的字符串资源**:
- 应用通用按钮和操作
- 本地数字人配置界面
- 云端数字人配置界面
- 下载相关提示
- 语言选择相关
- 错误提示信息

#### 2.3 WebView国际化系统

**文件位置**: `duix-sdk/src/main/assets/welcome/js/i18n.js`

**核心功能**:
- 定义多语言文本对象
- 提供文本获取函数
- 自动更新页面文本
- 与Android层通信

**关键函数**:
```javascript
setLanguage(lang)                    // 设置当前语言
getText(key)                         // 获取指定key的文本
updatePageText()                     // 更新页面所有文本
setLanguageFromAndroid(lang)         // Android调用设置语言
getCurrentLanguage()                 // 获取当前语言
```

**HTML标记**: 使用`data-i18n`属性标记需要国际化的元素
```html
<h1 data-i18n="welcome_title">欢迎使用索灵数字人</h1>
```

#### 2.4 语言切换UI设计

**位置**: 欢迎页面右上角

**设计特点**:
- 专业的语言图标（SVG）
- 圆角按钮设计，毛玻璃效果
- 下拉菜单选择语言
- 当前选中语言高亮显示
- 流畅的动画效果
- 响应式设计，适配移动端

**CSS样式**:
- 半透明背景 + backdrop-filter
- 悬停动画效果
- 选中状态标记（✓）
- 移动端自适应

#### 2.5 BaseActivity增强

**文件位置**: `test/src/main/java/ai/guiji/duix/test/ui/activity/BaseActivity.java`

**核心改动**:
```java
@Override
protected void attachBaseContext(Context newBase) {
    // 应用语言设置
    LanguageManager.Language language = LanguageManager.INSTANCE.getCurrentLanguage(newBase);
    Context context = LanguageManager.INSTANCE.applyLanguage(newBase, language);
    super.attachBaseContext(context);
}
```

**作用**:
- 所有Activity自动应用用户选择的语言
- 无需每个Activity单独处理
- 确保语言设置一致性

#### 2.6 WelcomeActivity国际化支持

**文件位置**: `duix-sdk/src/main/java/ai/guiji/duix/sdk/welcome/WelcomeActivity.kt`

**核心改动**:

1. **添加attachBaseContext方法**:
```kotlin
override fun attachBaseContext(newBase: Context) {
    val language = LanguageManager.getCurrentLanguage(newBase)
    val context = LanguageManager.applyLanguage(newBase, language)
    super.attachBaseContext(context)
}
```

2. **添加JavaScript接口**:
```kotlin
@JavascriptInterface
fun getCurrentLanguage(): String {
    val language = LanguageManager.getCurrentLanguage(this@WelcomeActivity)
    return language.code
}

@JavascriptInterface
fun onLanguageChanged(langCode: String) {
    runOnUiThread {
        val language = LanguageManager.Language.fromCode(langCode)
        LanguageManager.setLanguage(this@WelcomeActivity, language)
        recreate()
    }
}
```

3. **WebView加载完成后设置语言**:
```kotlin
override fun onPageFinished(view: WebView?, url: String?) {
    super.onPageFinished(view, url)
    isPageLoaded = true

    val currentLanguage = LanguageManager.getCurrentLanguage(this@WelcomeActivity)
    val langCode = currentLanguage.code
    webView.evaluateJavascript("setLanguageFromAndroid('$langCode')") {}

    animatePageEntry()
}
```

### 3. 工作流程

#### 3.1 初始化流程
1. 应用启动
2. MainActivity启动
3. BaseActivity.attachBaseContext被调用
4. LanguageManager读取用户语言偏好（如无则使用系统默认）
5. 应用语言设置到Context
6. 所有文本自动使用对应语言

#### 3.2 语言切换流程
1. 用户点击语言切换按钮
2. 显示语言选择下拉菜单
3. 用户选择语言
4. JavaScript调用`AndroidInterface.onLanguageChanged()`
5. LanguageManager保存语言选择
6. Activity调用`recreate()`重新创建
7. 新的语言设置被应用

#### 3.3 WebView语言同步流程
1. WelcomeActivity加载
2. WebView加载HTML页面
3. onPageFinished回调
4. 通过`setLanguageFromAndroid()`设置WebView语言
5. JavaScript更新页面所有文本

### 4. 关键设计原则

#### 4.1 单一职责
- LanguageManager仅负责语言管理
- BaseActivity负责语言应用
- i18n.js负责WebView文本管理

#### 4.2 依赖倒置
- 所有Activity依赖BaseActivity的语言设置
- WebView依赖JavaScript Bridge接口

#### 4.3 持久化存储
- 使用SharedPreferences保存用户选择
- 确保应用重启后保持用户设置

#### 4.4 可扩展性
- 语言枚举设计支持添加新语言
- 资源文件结构标准化
- JavaScript i18n对象易于扩展

### 5. 文件清单

#### 新增文件
1. `duix-sdk/src/main/java/ai/guiji/duix/sdk/i18n/LanguageManager.kt` - 语言管理器
2. `duix-sdk/src/main/assets/welcome/js/i18n.js` - WebView国际化脚本
3. `test/src/main/res/values-en/strings.xml` - 英文资源文件

#### 修改文件
1. `test/src/main/java/ai/guiji/duix/test/ui/activity/BaseActivity.java` - 添加attachBaseContext
2. `duix-sdk/src/main/java/ai/guiji/duix/sdk/welcome/WelcomeActivity.kt` - 添加国际化支持
3. `duix-sdk/src/main/assets/welcome/welcome.html` - 添加语言切换UI和i18n标记
4. `duix-sdk/src/main/assets/welcome/js/welcome.js` - 添加语言切换逻辑
5. `duix-sdk/src/main/assets/welcome/css/welcome.css` - 添加语言按钮样式
6. `test/src/main/res/values/strings.xml` - 重新组织和补充资源
7. `test/src/main/res/values-zh-rCN/strings.xml` - 补充完整的中文资源

### 6. 使用指南

#### 6.1 添加新语言
1. 在`LanguageManager.Language`枚举中添加新语言
2. 在`values-[语言代码]/strings.xml`中添加翻译
3. 在`i18n.js`的i18n对象中添加WebView翻译
4. 在HTML的语言选择下拉菜单中添加选项

#### 6.2 添加新文本
1. 在`values/strings.xml`中添加英文文本
2. 在`values-zh-rCN/strings.xml`中添加中文翻译
3. 如果是WebView文本，在`i18n.js`中添加对应翻译
4. 在HTML中使用`data-i18n`属性引用

### 7. 测试验证

#### 7.1 编译测试
执行`./gradlew assembleDebug`命令，编译成功，无错误无警告。

#### 7.2 功能测试点
- [ ] 首次启动应用，检查是否使用系统语言
- [ ] 点击语言切换按钮，检查下拉菜单显示
- [ ] 切换到英文，检查所有界面文本是否正确
- [ ] 切换到中文，检查所有界面文本是否正确
- [ ] 重启应用，检查是否保持上次选择的语言
- [ ] 检查欢迎页面、本地配置页面、云端配置页面的国际化
- [ ] 检查Toast提示、错误信息的国际化

### 8. 后续扩展建议

1. **增加更多语言**: 日语、韩语、法语等
2. **动态语言包**: 支持从服务器下载语言包
3. **RTL语言支持**: 支持阿拉伯语等从右到左的语言
4. **语言自动检测**: 根据IP或GPS自动推荐语言
5. **A/B测试**: 测试不同语言用户的使用习惯

### 9. 注意事项

1. **语言切换会重启Activity**: 这是为了确保所有资源正确加载
2. **WebView语言同步**: 必须在页面加载完成后设置
3. **资源命名规范**: 使用描述性的key名称
4. **字符串参数化**: 使用%s、%d等占位符支持动态内容
5. **避免硬编码**: 所有用户可见文本必须放在资源文件中

## 技术亮点

1. **完整的国际化架构**: 从底层到UI层全面支持
2. **WebView + Native混合国际化**: 无缝集成
3. **专业的UI设计**: 符合Material Design规范
4. **高可扩展性**: 易于添加新语言
5. **零侵入性**: 通过BaseActivity统一管理，业务代码无需关心

## 总结

本次实现了一个完整的、生产级的国际化系统，涵盖：
- ✅ 语言管理核心类
- ✅ Android资源国际化
- ✅ WebView国际化
- ✅ 语言切换UI
- ✅ BaseActivity自动应用语言
- ✅ 持久化存储
- ✅ 编译通过

所有代码遵循CLAUDE.md中的设计规范，采用模块化、单一职责、依赖倒置等原则，确保代码质量和可维护性。
