# 架构重构-本地云端分离-2025-10-02

## 重构背景

### 问题描述
- 应用启动后显示WelcomeActivity，提供"本地数字人"和"云端数字人"两个选项
- 不论点击哪个选项，都进入相同的MainActivity配置界面（本地数字人的配置）
- 缺少云端数字人界面
- 本地数字人和云端数字人的界面没有返回按钮

### 重构目标
1. 分离本地数字人和云端数字人的代码模块
2. 创建清晰的目录结构（local/cloud）
3. 实现正确的路由逻辑
4. 为所有界面添加返回主界面的功能
5. 遵循单一职责原则，MainActivity仅作为路由器

---

## 重构方案

### 1. 新的目录结构

```
test/src/main/java/ai/guiji/duix/test/ui/activity/
├── BaseActivity.java              # 所有Activity的基类（保持不变）
├── MainActivity.kt                # 路由器（仅负责启动WelcomeActivity和路由）
├── local/                         # 本地数字人模块
│   ├── LocalMainActivity.kt      # 本地配置界面（原MainActivity的逻辑）
│   └── LocalCallActivity.kt      # 本地播放界面（原CallActivity）
└── cloud/                         # 云端数字人模块
    └── CloudMainActivity.kt      # 云端界面（显示"尚未开发"）
```

```
test/src/main/res/layout/
├── activity_local_main.xml        # 本地配置界面（原activity_main.xml内容+返回按钮）
├── activity_local_call.xml        # 本地播放界面（原activity_call.xml内容+返回按钮）
└── activity_cloud_main.xml        # 云端界面（新建）
```

### 2. 文件变更清单

#### 新建文件
- `test/src/main/java/ai/guiji/duix/test/ui/activity/local/LocalMainActivity.kt`
- `test/src/main/java/ai/guiji/duix/test/ui/activity/local/LocalCallActivity.kt`
- `test/src/main/java/ai/guiji/duix/test/ui/activity/cloud/CloudMainActivity.kt`
- `test/src/main/res/layout/activity_local_main.xml`
- `test/src/main/res/layout/activity_local_call.xml`
- `test/src/main/res/layout/activity_cloud_main.xml`

#### 修改文件
- `test/src/main/java/ai/guiji/duix/test/ui/activity/MainActivity.kt`（重构为路由器）
- `test/src/main/AndroidManifest.xml`（更新Activity注册）

#### 保留原文件（待删除）
- `test/src/main/java/ai/guiji/duix/test/ui/activity/CallActivity.kt`
- `test/src/main/res/layout/activity_main.xml`
- `test/src/main/res/layout/activity_call.xml`

> 注：原文件保留以备回滚，后续可以删除

---

## 详细实现

### 1. MainActivity - 路由器

**职责：**
- 应用启动入口（LAUNCHER）
- 显示WelcomeActivity让用户选择
- 根据用户选择路由到对应Activity
- 无UI界面，作为透明的路由层

**核心逻辑：**
```kotlin
private fun checkAndRoute() {
    if (WelcomeConfig.shouldShowWelcomePage(this)) {
        // 第一次启动，显示欢迎页面
        showWelcomePage()
    } else {
        // 已选择过，直接路由
        routeBasedOnUserChoice()
    }
}

private fun routeBasedOnUserChoice() {
    when (WelcomeConfig.getUserChoiceEnum(this)) {
        UserChoice.LOCAL -> routeToLocalDigitalHuman()
        UserChoice.CLOUD -> routeToCloudDigitalHuman()
        else -> showWelcomePage()
    }
}
```

### 2. LocalMainActivity - 本地数字人配置界面

**功能：**
- 配置和下载本地数字人模型
- 配置基础配置文件
- 跳转到本地数字人播放界面
- 提供返回主界面按钮

**核心改动：**
- 从原MainActivity复制所有配置逻辑
- 移除WelcomeActivity相关代码
- 添加返回按钮：
  ```kotlin
  private fun backToHome() {
      WelcomeConfig.resetWelcomeConfig(this)
      val intent = Intent(this, MainActivity::class.java)
      intent.flags = Intent.FLAG_ACTIVITY_CLEAR_TOP or Intent.FLAG_ACTIVITY_NEW_TASK
      startActivity(intent)
      finish()
  }
  ```
- 跳转到`LocalCallActivity`而非`CallActivity`

### 3. LocalCallActivity - 本地数字人播放界面

**功能：**
- 渲染和播放本地数字人
- 支持音频驱动（PCM流/WAV文件）
- 支持动作控制
- 提供返回主界面按钮

**核心改动：**
- 从原CallActivity复制所有代码
- 添加返回按钮（同LocalMainActivity）
- 布局文件中添加返回按钮UI

### 4. CloudMainActivity - 云端数字人界面

**功能：**
- 显示"云端数字人尚未开发"提示
- 提供返回主界面按钮

**实现：**
- 简洁的提示界面
- 返回逻辑与本地模块一致

### 5. AndroidManifest.xml 更新

```xml
<!-- MainActivity保持LAUNCHER -->
<activity android:name=".ui.activity.MainActivity" android:exported="true">
    <intent-filter>
        <action android:name="android.intent.action.MAIN" />
        <category android:name="android.intent.category.LAUNCHER" />
    </intent-filter>
</activity>

<!-- 本地数字人 -->
<activity android:name=".ui.activity.local.LocalMainActivity" android:exported="false" />
<activity android:name=".ui.activity.local.LocalCallActivity" android:exported="false" />

<!-- 云端数字人 -->
<activity android:name=".ui.activity.cloud.CloudMainActivity" android:exported="false" />

<!-- 欢迎页面 -->
<activity android:name="ai.guiji.duix.sdk.welcome.WelcomeActivity" ... />
```

---

## 用户流程

### 完整流程图

```
1. 应用启动
   ↓
2. MainActivity（路由器）
   ↓
3. 检查是否需要显示WelcomeActivity
   ├─ 是（首次启动） → 显示WelcomeActivity → 用户选择
   │                        ├─ 本地 → LocalMainActivity（配置）
   │                        │            ↓
   │                        │         LocalCallActivity（播放）
   │                        │            ↓
   │                        │         点击返回 → WelcomeActivity
   │                        │
   │                        └─ 云端 → CloudMainActivity（未开发提示）
   │                                     ↓
   │                                  点击返回 → WelcomeActivity
   │
   └─ 否（已选择） → 根据历史选择直接路由
                      ├─ 本地 → LocalMainActivity
                      └─ 云端 → CloudMainActivity
```

### 返回逻辑说明

所有子界面（LocalMainActivity、LocalCallActivity、CloudMainActivity）的返回按钮都会：
1. 调用`WelcomeConfig.resetWelcomeConfig(this)` - 重置配置
2. 启动MainActivity（带CLEAR_TOP标志）
3. MainActivity检测到配置被重置，重新显示WelcomeActivity
4. 用户可以重新选择本地或云端

---

## 设计原则遵循

### 1. 单一职责原则
- ✅ MainActivity：仅负责路由
- ✅ LocalMainActivity：仅负责本地配置
- ✅ LocalCallActivity：仅负责本地播放
- ✅ CloudMainActivity：仅负责云端提示

### 2. 模块化
- ✅ 本地数字人模块（local包）
- ✅ 云端数字人模块（cloud包）
- ✅ 低耦合、高内聚

### 3. 可扩展性
- ✅ 云端模块预留位置，后续可直接开发
- ✅ 目录结构清晰，便于添加新功能

---

## 编译验证

### 编译命令
```bash
./gradlew clean
./gradlew :test:assembleDebug
```

### 编译结果
```
BUILD SUCCESSFUL in 20s
56 actionable tasks: 11 executed, 45 up-to-date
```

### 遇到的问题和解决方案

#### 问题1：`clearUserChoice()` 方法不存在
**错误信息：**
```
Unresolved reference: clearUserChoice
```

**原因：**
WelcomeConfig中没有`clearUserChoice()`方法，实际方法名为`resetWelcomeConfig()`

**解决方案：**
将所有`WelcomeConfig.clearUserChoice(this)`替换为`WelcomeConfig.resetWelcomeConfig(this)`

**涉及文件：**
- LocalMainActivity.kt
- LocalCallActivity.kt
- CloudMainActivity.kt

---

## 后续任务

### 可选优化
1. 删除原CallActivity.kt和原布局文件
2. 为返回按钮添加图标（当前使用"←"文本）
3. 添加Activity切换动画
4. 添加单元测试验证路由逻辑

### 云端数字人开发
当开始云端数字人开发时：
1. 在`cloud/`目录下添加相关Activity
2. 更新CloudMainActivity实现实际功能
3. 创建对应的布局和资源文件

---

## 总结

本次重构成功实现了本地数字人和云端数字人的代码分离，建立了清晰的模块化架构，并且所有界面都具有返回主界面的功能。重构过程遵循了单一职责原则，MainActivity仅作为路由器，业务逻辑分离到各自的模块中。

### 重构成果
- ✅ 创建了local和cloud两个模块
- ✅ MainActivity改造为纯路由器
- ✅ 所有界面都有返回按钮
- ✅ 点击本地/云端能正确路由到对应界面
- ✅ 编译通过，无错误无警告
- ✅ 代码结构清晰，易于维护和扩展

### 符合项目规范
- ✅ 单一职责
- ✅ 模块化
- ✅ 低耦合、高内聚
- ✅ 详细的代码注释
- ✅ 清晰的文件功能说明
