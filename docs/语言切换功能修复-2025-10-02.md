# 语言切换功能修复

**日期**: 2025-10-02

## 问题描述

用户反馈了三个语言切换相关的问题：

1. **下拉菜单问题**：点击语言选择按钮后，下拉菜单没有正确显示
2. **切换功能失效**：点击"中文"或"English"后没有实际切换语言
3. **默认语言错误**：应用应该默认使用中文，但使用了系统语言

## 根本原因

语言选择器使用的是WebView中的JavaScript实现，但实际的语言管理是通过Android原生的LanguageManager实现的。这两个系统之间缺少正确的桥接：

1. WebView的`changeLanguage()`函数没有正确调用Android的JavaScriptInterface
2. Android端的`changeLanguage()`方法不存在（只有`onLanguageChanged()`）
3. LanguageManager默认使用系统语言而不是中文

## 解决方案

### 1. 修改 welcome.js

**文件**: `duix-sdk/src/main/assets/welcome/js/welcome.js`

**修改内容**:
- 更新了`changeLanguage()`函数，使其正确调用Android的JavaScriptInterface
- 修复了点击其他区域关闭下拉菜单的选择器（从`.language-selector`改为`.language-selector-bottom`）

```javascript
function changeLanguage(lang) {
    // 隐藏下拉菜单
    const dropdown = document.getElementById('languageDropdown');
    if (dropdown) {
        dropdown.classList.remove('show');
    }

    // 调用Android接口切换语言
    if (window.AndroidInterface && window.AndroidInterface.changeLanguage) {
        window.AndroidInterface.changeLanguage(lang);
    } else {
        // 如果没有Android接口，使用i18n.js的方式
        if (typeof setLanguage === 'function') {
            setLanguage(lang);
        }
    }
}
```

### 2. 修改 i18n.js

**文件**: `duix-sdk/src/main/assets/welcome/js/i18n.js`

**修改内容**:
- 添加了语言选择器相关的字符串资源
- 添加了`window.initLanguage()`函数，用于从Android接收初始语言设置
- 添加了DOMContentLoaded事件监听器，默认设置为中文

```javascript
// 添加的字符串资源
language_selector: "语言",
language_chinese: "中文",
language_english: "English"

// 初始化语言
window.initLanguage = function(lang) {
    currentLanguage = lang || 'zh';
    updatePageText();
};

// 页面加载时默认中文
window.addEventListener('DOMContentLoaded', function() {
    currentLanguage = 'zh';
    updatePageText();
});
```

### 3. 修改 WelcomeActivity.kt

**文件**: `duix-sdk/src/main/java/ai/guiji/duix/sdk/welcome/WelcomeActivity.kt`

**修改内容**:
- 在WebAppInterface中添加了`changeLanguage()`方法
- 保留了`onLanguageChanged()`方法以保持向后兼容

```kotlin
/**
 * 切换语言（新方法，从WebView调用）
 */
@JavascriptInterface
fun changeLanguage(langCode: String) {
    runOnUiThread {
        val language = LanguageManager.Language.fromCode(langCode)
        LanguageManager.setLanguage(this@WelcomeActivity, language)

        // 重新加载Activity以应用语言变更
        recreate()
    }
}

/**
 * 处理语言变更（保留兼容性）
 */
@JavascriptInterface
fun onLanguageChanged(langCode: String) {
    changeLanguage(langCode)
}
```

### 4. 修改 LanguageManager.kt

**文件**: `duix-sdk/src/main/java/ai/guiji/duix/sdk/i18n/LanguageManager.kt`

**修改内容**:
- 修改了`getCurrentLanguage()`方法，将默认语言从系统语言改为中文

```kotlin
/**
 * 获取当前语言
 * 默认返回中文
 */
fun getCurrentLanguage(context: Context): Language {
    val prefs = context.getSharedPreferences(PREF_NAME, Context.MODE_PRIVATE)
    val languageCode = prefs.getString(KEY_LANGUAGE, null)
    return if (languageCode != null) {
        Language.fromCode(languageCode)
    } else {
        // 默认使用中文
        Language.CHINESE
    }
}
```

## 测试验证

编译成功，无错误和警告。

## 预期行为

修复后：
1. ✅ 点击语言按钮 → 下拉菜单正确显示"中文"和"English"两个选项
2. ✅ 点击"中文" → 界面切换为中文，Activity重新加载
3. ✅ 点击"English" → 界面切换为英文，Activity重新加载
4. ✅ 应用首次启动 → 默认显示中文界面
5. ✅ 语言选择持久化保存，下次打开应用仍然使用上次选择的语言

## 技术要点

### WebView与Android通信机制
- 使用`@JavascriptInterface`注解标记可被JavaScript调用的方法
- WebView通过`window.AndroidInterface.methodName()`调用Android方法
- 所有UI操作必须在`runOnUiThread {}`中执行

### 语言切换流程
1. 用户在WebView中点击语言选项
2. JavaScript调用`changeLanguage('zh')` 或 `changeLanguage('en')`
3. Android的JavaScriptInterface接收调用
4. 保存语言设置到SharedPreferences
5. 调用`recreate()`重新创建Activity
6. Activity的`attachBaseContext()`中应用新的语言设置
7. WebView重新加载，显示新语言的内容

## 相关文件

- `duix-sdk/src/main/assets/welcome/js/welcome.js`
- `duix-sdk/src/main/assets/welcome/js/i18n.js`
- `duix-sdk/src/main/java/ai/guiji/duix/sdk/welcome/WelcomeActivity.kt`
- `duix-sdk/src/main/java/ai/guiji/duix/sdk/i18n/LanguageManager.kt`
