# Gradle内存配置优化

**日期**: 2025-10-02
**状态**: 已解决
**优先级**: 高

## 问题描述

在 Windows 环境下编译项目时，Gradle daemon 无法启动，出现以下错误：

```
Could not run phased build action using connection to Gradle distribution
Unable to start the daemon process.
error='页面文件太小,无法完成操作' (DOS error/errno=1455)
There is insufficient memory for the Java Runtime Environment to continue.
Native memory allocation (mmap) failed to map 2147483648 bytes.
```

## 根本原因分析

### 1. 错误原因
- **Windows 虚拟内存不足**: 错误代码 1455 表示系统的页面文件（虚拟内存）太小
- **JVM 内存需求过高**: Gradle daemon 尝试分配 2GB 初始堆内存（-Xms2048m）失败
- **配置不一致**: gradle.properties 配置为 -Xms1024m，但实际运行时显示为 -Xms2048m

### 2. 配置来源分析
通过 repomix 工具打包项目并分析依赖关系，发现：
- `gradle.properties` 中配置: `-Xms1024m -Xmx4096m`
- 实际运行时配置: `-Xms2048m -Xmx6656m`
- 说明被 IDE（Android Studio）或其他工具覆盖了配置

## 解决方案

### 修改 gradle.properties

降低 JVM 堆内存分配，从：
```properties
org.gradle.jvmargs=-Xms1024m -Xmx4096m -XX:MaxMetaspaceSize=512m -XX:+HeapDumpOnOutOfMemoryError -Dfile.encoding=UTF-8
```

修改为：
```properties
org.gradle.jvmargs=-Xms512m -Xmx2048m -XX:MaxMetaspaceSize=512m -XX:+HeapDumpOnOutOfMemoryError -Dfile.encoding=UTF-8
```

### 修改内容说明
- **-Xms512m**: 初始堆内存从 1024m 降低到 512m，减少启动时的内存需求
- **-Xmx2048m**: 最大堆内存从 4096m 降低到 2048m，对于中等规模的 Android 项目足够使用
- **保留其他参数**: MaxMetaspaceSize、HeapDumpOnOutOfMemoryError、file.encoding 保持不变

## 验证结果

### 1. Gradle 版本检查
```bash
./gradlew --version
```

**输出**:
```
Gradle 8.0
JVM: 17.0.16 (Microsoft 17.0.16+8-LTS)
OS: Windows 11 10.0 amd64
```
✅ Gradle daemon 成功启动

### 2. 任务列表检查
```bash
./gradlew tasks --all
```

**输出**:
```
Starting a Gradle Daemon, 1 incompatible Daemon could not be reused
> Task :tasks
Tasks runnable from root project 'human_android'
...
```
✅ 新的 daemon 成功启动，能够正常执行任务

## 技术要点

### 1. 为什么要降低初始内存（-Xms）？
- 初始堆内存是 JVM 启动时立即分配的内存
- 在虚拟内存不足的系统上，过大的初始堆会导致启动失败
- 512m 对于 Gradle daemon 的启动是足够的，后续可以根据需要增长到最大堆内存

### 2. 为什么 2048m 最大堆内存足够？
- 本项目是一个中等规模的 Android SDK 项目（duix-sdk + test）
- 包含 Native 代码（C++/CMake）但编译主要在 NDK 层完成
- 2GB 最大堆内存对于大多数 Android 构建任务已经足够
- 如果后续出现 OutOfMemoryError，可以适当增加

### 3. Windows 虚拟内存优化建议
如果仍然遇到内存问题，可以考虑：
- 增加 Windows 页面文件大小（建议设置为物理内存的 1.5-2 倍）
- 关闭不必要的后台程序释放内存
- 升级物理内存

## 相关文件

- **配置文件**: `gradle.properties`
- **备份文件**: `gradle.properties.backup`（修改前自动创建）
- **问题诊断**: 使用 repomix MCP 工具分析项目结构和依赖关系

## 后续建议

1. **监控构建性能**: 使用 `./gradlew build --profile` 生成性能报告
2. **清理旧 daemon**: 定期运行 `./gradlew --stop` 清理不使用的 daemon 进程
3. **更新文档**: 已按照 CLAUDE.md 要求创建本文档并记录问题解决过程

## 参考资源

- [Gradle Daemon 文档](https://docs.gradle.org/8.0/userguide/gradle_daemon.html)
- [JVM 内存配置最佳实践](https://docs.gradle.org/current/userguide/build_environment.html#sec:configuring_jvm_memory)
