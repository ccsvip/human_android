# Human Android 项目说明文档

> 文档生成时间: 2025-10-02
> SDK版本: v4.1.1
> 文档版本: 1.0.0

---

## 📋 目录

1. [项目概述](#项目概述)
2. [项目架构](#项目架构)
3. [目录结构](#目录结构)
4. [程序入口点](#程序入口点)
5. [依赖关系分析](#依赖关系分析)
6. [核心模块说明](#核心模块说明)
7. [文件功能说明](#文件功能说明)
8. [目录解耦分析](#目录解耦分析)
9. [待完成事项(TODO)](#待完成事项todo)
10. [技术栈](#技术栈)
11. [构建与部署](#构建与部署)

---

## 项目概述

**Human Android** 是一个基于Android平台的2D虚拟数字人SDK项目，提供轻量级、纯离线的数字人解决方案。项目支持通过语音音频驱动数字人形象并进行实时渲染，适用于移动端的虚拟助手、虚拟主播等应用场景。

### 核心特性

- ✅ **纯离线运行** - 所有AI推理均在本地完成，无需网络连接
- ✅ **实时渲染** - 基于OpenGL ES的高性能2D渲染引擎
- ✅ **音频驱动** - 支持PCM流和WAV文件驱动口型动画
- ✅ **动作控制** - 支持预定义动作和随机动作播放
- ✅ **模型管理** - 完整的模型下载、解压、校验机制
- ✅ **双模式支持** - 支持本地模式和云端模式

### 系统要求

- **最低SDK版本**: Android 7.0 (API 24)
- **目标SDK版本**: Android 13/14 (API 33/34)
- **推荐硬件**:
  - CPU: 8核及以上（推荐骁龙8 Gen2）
  - 内存: 8GB及以上
  - 存储: 1GB可用空间
  - 支持架构: arm64-v8a, armeabi-v7a

---

## 项目架构

### 模块划分

项目采用**模块化架构设计**，由两个主要模块组成：

```
human_android/
├── duix-sdk/          # 核心SDK库模块（可独立发布的AAR）
└── test/              # 示例应用模块（展示SDK用法）
```

### 架构分层

```
┌─────────────────────────────────────────┐
│         Application Layer               │  (test模块)
│   - MainActivity (入口)                 │
│   - CallActivity (数字人播放)           │
│   - WelcomeActivity (欢迎页)            │
└─────────────────────────────────────────┘
                    ↓
┌─────────────────────────────────────────┐
│          SDK Layer                      │  (duix-sdk模块)
│   ┌─────────────────────────────────┐  │
│   │   DUIX (主控类)                 │  │
│   │   - init()                      │  │
│   │   - playAudio()                 │  │
│   │   - startMotion()               │  │
│   └─────────────────────────────────┘  │
│              ↓           ↓              │
│   ┌──────────────┐  ┌─────────────┐   │
│   │ RenderThread │  │ AudioPlayer │   │
│   └──────────────┘  └─────────────┘   │
│              ↓                          │
│   ┌─────────────────────────────────┐  │
│   │   DUIXRenderer (OpenGL渲染)     │  │
│   └─────────────────────────────────┘  │
└─────────────────────────────────────────┘
                    ↓
┌─────────────────────────────────────────┐
│        Native Layer (JNI)               │
│   ┌─────────────────────────────────┐  │
│   │   gjduix.so (C++ Native库)      │  │
│   │   - gjduix.cpp (主控逻辑)       │  │
│   │   - gjsimp.cpp (简化接口)       │  │
│   └─────────────────────────────────┘  │
│              ↓           ↓              │
│   ┌──────────────┐  ┌─────────────┐   │
│   │   dhunet     │  │   dhmfcc    │   │
│   │ (AI推理模块) │  │ (音频特征)  │   │
│   └──────────────┘  └─────────────┘   │
└─────────────────────────────────────────┘
                    ↓
┌─────────────────────────────────────────┐
│      Third-Party Libraries              │
│   - NCNN (神经网络推理)                 │
│   - OpenCV (图像处理)                   │
│   - ONNX Runtime (模型运行时)           │
│   - TurboJPEG (图像编解码)              │
└─────────────────────────────────────────┘
```

---

## 目录结构

### 完整目录树

```
human_android/
├── .git/                               # Git版本控制
├── .mcp.json                           # MCP配置文件
├── .claudeignore                       # Claude忽略配置
├── CLAUDE.md                           # Claude指令文档
├── README.md                           # 项目说明
├── build.gradle                        # 根级构建配置
├── settings.gradle                     # 模块配置
├── gradle.properties                   # Gradle属性
├── gradlew                             # Gradle包装脚本
├── android_glide_lint.xml              # Glide Lint配置
│
├── docs/                               # 项目文档目录
│   ├── 编译错误修复-2025-09-29.md
│   ├── 欢迎页面功能实现-2025-09-29.md
│   ├── 欢迎页面专业美化实现-2025-09-30.md
│   ├── 欢迎页面界面美化-2025-10-02.md
│   ├── 家庭环境编译配置-2025-10-01.md
│   └── 数字人停止播放按钮设计分析-2025-09-30.md
│
├── duix-sdk/                           # ========== 核心SDK模块 ==========
│   ├── build.gradle                    # SDK构建配置
│   ├── proguard-rules.pro              # 混淆规则
│   ├── .gitignore
│   │
│   └── src/main/
│       ├── AndroidManifest.xml         # SDK清单文件
│       │
│       ├── assets/                     # 资源文件
│       │   └── welcome/                # 欢迎页面资源
│       │       ├── welcome.html        # 欢迎页HTML
│       │       ├── js/welcome.js       # 欢迎页脚本
│       │       └── css/tailwind.min.css # Tailwind CSS
│       │
│       ├── java/ai/guiji/duix/         # Java/Kotlin源码
│       │   │
│       │   ├── DuixNcnn.java           # JNI接口声明
│       │   │
│       │   └── sdk/
│       │       ├── client/             # ========== SDK客户端包 ==========
│       │       │   ├── DUIX.java                   # ⭐ 核心主控类
│       │       │   ├── Callback.java               # 事件回调接口
│       │       │   ├── Constant.java               # 常量定义
│       │       │   ├── VirtualModelUtil.java       # 模型工具类
│       │       │   │
│       │       │   ├── audio/                      # 音频模块
│       │       │   │   └── AudioPlayer.java        # 音频播放器
│       │       │   │
│       │       │   ├── bean/                       # 数据模型
│       │       │   │   ├── AudioFrame.java         # 音频帧
│       │       │   │   └── ImageFrame.java         # 图像帧
│       │       │   │
│       │       │   ├── net/                        # 网络模块
│       │       │   │   ├── FileDownloader.java     # 文件下载器
│       │       │   │   └── DownloadZipService.java # ZIP下载服务
│       │       │   │
│       │       │   ├── render/                     # ⭐ 渲染模块
│       │       │   │   ├── DUIXRenderer.java       # OpenGL渲染器
│       │       │   │   ├── DUIXTextureView.java    # 纹理视图
│       │       │   │   ├── ImageDrawer.java        # 图像绘制器
│       │       │   │   ├── TextureMatrix.java      # 纹理矩阵
│       │       │   │   └── RenderSink.java         # 渲染接收器接口
│       │       │   │
│       │       │   ├── thread/                     # 线程模块
│       │       │   │   └── RenderThread.java       # ⭐ 渲染线程
│       │       │   │
│       │       │   └── util/                       # 工具类
│       │       │       ├── DeviceUtils.java        # 设备工具
│       │       │       ├── FileUtil.java           # 文件工具
│       │       │       ├── Logger.java             # 日志工具
│       │       │       ├── MD5Util.java            # MD5工具
│       │       │       ├── OpenGLUtil.java         # OpenGL工具
│       │       │       ├── SystemUtils.java        # 系统工具
│       │       │       └── ZipUtil.java            # ZIP工具
│       │       │
│       │       └── welcome/            # 欢迎页面模块
│       │           ├── WelcomeActivity.kt          # 欢迎页Activity
│       │           ├── WelcomeConfig.kt            # 欢迎页配置
│       │           └── WelcomeIntegrationExample.kt # 集成示例
│       │
│       └── cpp/                        # ========== C++ Native代码 ==========
│           ├── CMakeLists.txt          # ⭐ CMake构建脚本
│           │
│           ├── include/                # 公共头文件
│           │   ├── gjduix.h            # DUIX主接口
│           │   ├── gjsimp.h            # 简化接口
│           │   ├── dhextend.h          # 扩展接口
│           │   ├── dhextctrl.h         # 控制接口
│           │   ├── dhextinc.h          # 包含文件
│           │   ├── aicommon.h          # AI通用定义
│           │   └── gj_dll.h            # DLL导出定义
│           │
│           ├── duix/                   # ⭐ DUIX核心实现
│           │   ├── gjduix.cpp          # 主控实现
│           │   └── gjsimp.cpp          # 简化接口实现
│           │
│           ├── android/                # Android JNI层
│           │   ├── DuixJni.cpp         # JNI接口实现
│           │   ├── JniHelper.cpp       # JNI辅助工具
│           │   ├── JniHelper.h
│           │   ├── Log.cpp             # 日志实现
│           │   └── Log.h
│           │
│           ├── dhcore/                 # ⭐ 核心数据结构库
│           │   ├── dh_atomic.h         # 原子操作
│           │   ├── dh_types.h          # 类型定义
│           │   ├── dh_mem.c/h          # 内存管理
│           │   ├── dh_data.cpp/h       # 数据结构
│           │   ├── dh_que.cpp/h        # 队列实现
│           │   ├── atomicops.h         # 原子操作
│           │   ├── concurrentqueue.h   # 并发队列
│           │   ├── blockingconcurrentqueue.h
│           │   ├── readerwriterqueue.h
│           │   ├── readerwritercircularbuffer.h
│           │   └── lightweightsemaphore.h
│           │
│           ├── dhmfcc/                 # ⭐ 音频特征提取模块
│           │   ├── dhpcm.cpp/h         # PCM音频处理
│           │   ├── dhwenet.cpp/h       # WeNet集成
│           │   ├── wenetai.cpp/h       # WeNet AI接口
│           │   ├── AudioFFT.cpp        # FFT音频分析
│           │   ├── iir_filter.cpp      # IIR滤波器
│           │   ├── mfcc.cpp            # MFCC特征提取
│           │   └── mfcc/               # MFCC头文件
│           │       ├── AudioFFT.hpp
│           │       ├── iir_filter.hpp
│           │       └── mfcc.hpp
│           │
│           ├── dhunet/                 # ⭐ AI推理模块
│           │   ├── munet.cpp/h         # UNet模型推理
│           │   ├── malpha.cpp/h        # Alpha通道处理
│           │   ├── blendgram.cpp/h     # 混合图处理
│           │   ├── jmat.cpp/h          # 矩阵运算
│           │   └── face_utils.cpp/h    # 人脸工具
│           │
│           ├── aes/                    # AES加密模块
│           │   ├── aes_core.c          # AES核心算法
│           │   ├── aes_cbc.c           # CBC模式
│           │   ├── aes_ecb.c           # ECB模式
│           │   ├── cbc128.c            # CBC128实现
│           │   ├── gj_aes.c/h          # 自定义AES接口
│           │   ├── gaes_stream.cc/h    # AES流处理
│           │   ├── base64.c/h          # Base64编解码
│           │   ├── aesmain.c/h         # AES主接口
│           │   └── aes*.h              # AES头文件
│           │
│           ├── iostest/                # 测试程序
│           │   ├── testduix.cpp
│           │   └── testsimp.cpp
│           │
│           ├── mk/                     # 构建脚本
│           │   ├── Android.mk64
│           │   ├── android.sh
│           │   ├── bt
│           │   └── exbuildso64
│           │
│           └── third/                  # ⭐ 第三方库
│               ├── arm/                # ARM架构库
│               │   ├── arm64-v8a/      # 64位ARM库
│               │   ├── armeabi-v7a/    # 32位ARM库
│               │   │   ├── libcurl.la
│               │   │   ├── libonnxruntime.so
│               │   │   ├── libturbojpeg.a
│               │   │   └── libjpeg.a
│               │   └── include/        # 第三方头文件
│               │       ├── ncnn/       # NCNN神经网络库
│               │       ├── onnx/       # ONNX运行时
│               │       ├── opencv2/    # OpenCV库
│               │       ├── ffmpeg/     # FFmpeg库
│               │       ├── tjpeg/      # TurboJPEG库
│               │       ├── turbojpeg/
│               │       └── rknn_api.h  # RockChip NPU API
│               │
│               ├── ncnn-20221128-android-vulkan-shared/  # NCNN Vulkan版
│               ├── ncnn-20231027-android-shared/         # NCNN标准版
│               └── opencv-mobile-4.6.0-android/          # OpenCV移动版
│
└── test/                               # ========== 示例应用模块 ==========
    ├── build.gradle                    # 应用构建配置
    ├── proguard-rules.pro              # 混淆规则
    ├── lint-baseline.xml               # Lint基线
    ├── .gitignore
    │
    └── src/main/
        ├── AndroidManifest.xml         # 应用清单
        │
        ├── java/ai/guiji/duix/test/
        │   ├── App.java                # ⭐ Application入口
        │   │
        │   ├── ui/                     # UI模块
        │   │   ├── activity/           # Activity层
        │   │   │   ├── BaseActivity.java       # 基础Activity
        │   │   │   ├── MainActivity.kt         # ⭐ 主界面(路由)
        │   │   │   │
        │   │   │   ├── local/                  # 本地数字人模块
        │   │   │   │   ├── LocalMainActivity.kt    # 本地数字人配置界面
        │   │   │   │   └── LocalCallActivity.kt    # 本地数字人播放界面
        │   │   │   │
        │   │   │   └── cloud/                  # 云端数字人模块
        │   │   │       └── CloudMainActivity.kt    # 云端数字人占位界面
        │   │   │
        │   │   ├── adapter/            # 适配器
        │   │   │   ├── ModelSelectorAdapter.kt # 模型选择器
        │   │   │   └── MotionAdapter.kt        # 动作适配器
        │   │   │
        │   │   └── dialog/             # 对话框
        │   │       ├── LoadingDialog.kt        # 加载对话框
        │   │       ├── AudioRecordDialog.kt    # 录音对话框
        │   │       └── ModelSelectorDialog.kt  # 模型选择对话框
        │   │
        │   ├── audio/                  # 音频模块
        │   │   └── AudioRecorder.java  # 音频录制器
        │   │
        │   ├── net/                    # 网络模块
        │   │   └── SyncDownloadFile.java # 同步下载
        │   │
        │   ├── render/                 # 渲染模块
        │   │   └── DebugSink.java      # 调试渲染接收器
        │   │
        │   ├── service/                # 服务层
        │   │   └── StorageService.java # 存储服务
        │   │
        │   └── util/                   # 工具类
        │       ├── StringUtils.java    # 字符串工具
        │       ├── SystemUtils.java    # 系统工具
        │       └── ZipUtil.java        # ZIP工具
        │
        └── res/                        # Android资源
            ├── layout/                 # 布局文件
            │   ├── activity_cloud_main.xml     # 云端主界面布局
            │   ├── activity_local_main.xml     # 本地主界面布局
            │   ├── activity_local_call.xml     # 本地播放界面布局
            │   ├── dialog_*.xml
            │   └── item_*.xml
            │
            ├── drawable/               # 图形资源
            │   └── ic_back_to_home.xml         # 返回主界面图标
            │
            ├── values/                 # 值资源
            │   ├── strings.xml
            │   ├── colors.xml
            │   ├── themes.xml
            │   ├── style.xml
            │   ├── attrs.xml
            │   ├── dimens.xml                  # 尺寸资源
            │   └── fab_styles.xml              # FloatingActionButton样式
            │
            ├── values-zh-rCN/          # 中文资源
            ├── anim/                   # 动画资源
            └── xml/                    # XML配置
                └── network_security_config.xml
```

---

## 程序入口点

### 1. Application层入口

**文件**: `test/src/main/java/ai/guiji/duix/test/App.java`

```java
public class App extends Application {
    public static App mApp;
    private static OkHttpClient mOkHttpClient;

    @Override
    public void onCreate() {
        super.onCreate();
        mApp = this;
    }

    // 提供全局OkHttpClient实例
    public static OkHttpClient getOkHttpClient() { ... }
}
```

**功能**:
- 应用程序全局初始化
- 提供全局OkHttpClient实例用于网络请求

---

### 2. 主界面入口(路由)

**文件**: `test/src/main/java/ai/guiji/duix/test/ui/activity/MainActivity.kt`

```kotlin
class MainActivity : BaseActivity() {
    // 路由逻辑
    override fun onCreate(savedInstanceState: Bundle?) {
        super.onCreate(savedInstanceState)

        // 1. 检查并显示欢迎页面（首次启动）
        checkAndShowWelcomePage()

        // 2. 根据用户选择路由到对应界面
        routeBasedOnUserChoice()
    }
}
```

**启动流程**:
```
App.onCreate()
    ↓
MainActivity.onCreate()
    ↓
检查是否首次启动
    ↓
├─[是] → 显示WelcomeActivity（模式选择）
│           ↓
│       用户选择模式（本地/云端）
│           ↓
│       保存用户选择
│           ↓
│       返回MainActivity
│           ↓
└─[否] → 根据用户选择路由
    ↓
├─[本地模式] → LocalMainActivity (本地数字人配置)
│                     ↓
│                LocalCallActivity (本地数字人播放)
│
└─[云端模式] → CloudMainActivity (云端数字人占位)
```

---

### 3. 本地数字人配置入口

**文件**: `test/src/main/java/ai/guiji/duix/test/ui/activity/local/LocalMainActivity.kt`

```kotlin
class LocalMainActivity : BaseActivity() {
    override fun onCreate(savedInstanceState: Bundle?) {
        super.onCreate(savedInstanceState)
        setupUI()

        // 用户操作：
        // 1. 选择模型
        // 2. 下载模型
        // 3. 启动LocalCallActivity
    }
}
```

---

### 4. 本地数字人播放入口

**文件**: `test/src/main/java/ai/guiji/duix/test/ui/activity/local/LocalCallActivity.kt`

```kotlin
class LocalCallActivity : BaseActivity() {
    private var duix: DUIX? = null
    private var mDUIXRender: DUIXRenderer? = null

    override fun onCreate(savedInstanceState: Bundle?) {
        // 1. 初始化OpenGL渲染视图
        setupGLView()

        // 2. 创建DUIX实例
        duix = DUIX(context, modelUrl, renderer, callback)

        // 3. 初始化数字人
        duix.init()
    }
}
```

**数字人初始化流程**:
```
LocalCallActivity.onCreate()
    ↓
创建DUIXRenderer（OpenGL渲染器）
    ↓
创建DUIX实例
    ↓
DUIX.init()
    ↓
检查模型文件
    ├─ gj_dh_res (基础配置)
    └─ 具体模型文件
    ↓
创建RenderThread（渲染线程）
    ↓
Native层初始化 (gjduix.cpp)
    ↓
加载AI模型
    ├─ NCNN模型
    ├─ ONNX模型
    └─ 模型配置
    ↓
回调: CALLBACK_EVENT_INIT_READY
    ↓
数字人就绪，可以播放
```

---

### 5. 云端数字人入口

**文件**: `test/src/main/java/ai/guiji/duix/test/ui/activity/cloud/CloudMainActivity.kt`

```kotlin
class CloudMainActivity : BaseActivity() {
    override fun onCreate(savedInstanceState: Bundle?) {
        super.onCreate(savedInstanceState)

        // 显示占位界面
        // 提示：云端数字人功能尚未开发
    }
}
```

---

### 6. SDK核心入口

**文件**: `duix-sdk/src/main/java/ai/guiji/duix/sdk/client/DUIX.java`

```java
public class DUIX {
    private RenderThread mRenderThread;

    // 主初始化方法
    public void init() {
        // 1. 检查模型文件
        checkModelFiles();

        // 2. 创建渲染线程
        mRenderThread = new RenderThread(...);
        mRenderThread.start();
    }

    // PCM音频驱动
    public void startPush() { ... }
    public void pushPcm(byte[] buffer) { ... }
    public void stopPush() { ... }

    // WAV文件播放
    public void playAudio(String wavPath) { ... }
    public void stopAudio() { ... }

    // 动作控制
    public void startMotion(String name, boolean now) { ... }
    public void startRandomMotion(boolean now) { ... }
}
```

**核心API调用链**:
```
DUIX.init()
    ↓
RenderThread.start()
    ↓
Native: gjduix_init() [JNI]
    ↓
加载模型和资源
    ↓
启动渲染循环

────────────────────────

音频播放流程:
DUIX.playAudio()
    ↓
DUIX.startPush()
    ↓
DUIX.pushPcm() [循环]
    ↓
RenderThread.pushAudio()
    ↓
Native: 音频特征提取 (dhmfcc)
    ↓
Native: AI推理生成图像 (dhunet)
    ↓
OpenGL渲染图像
    ↓
DUIX.stopPush()
```

---

### 5. Native层入口

**文件**: `duix-sdk/src/main/cpp/android/DuixJni.cpp`

```cpp
// JNI入口点
JNIEXPORT jint JNICALL
Java_ai_guiji_duix_DuixNcnn_duixInit(
    JNIEnv* env, jclass clazz,
    jstring modelPath, jlong callback) {

    // 调用gjduix核心
    return gjduix_init(...);
}

JNIEXPORT jint JNICALL
Java_ai_guiji_duix_DuixNcnn_duixPushAudio(
    JNIEnv* env, jclass clazz,
    jbyteArray pcmData) {

    // 推送音频数据
    return gjduix_push_audio(...);
}
```

**Native调用链**:
```
JNI层 (DuixJni.cpp)
    ↓
DUIX核心 (gjduix.cpp)
    ├─ 模型加载
    ├─ 音频处理
    └─ 图像生成
    ↓
子模块调用:
├─ dhcore   (内存管理、队列)
├─ dhmfcc   (音频特征提取)
└─ dhunet   (AI模型推理)
    ↓
第三方库:
├─ NCNN     (神经网络推理)
├─ ONNX     (模型运行时)
├─ OpenCV   (图像处理)
└─ TurboJPEG (JPEG编解码)
```

---

## 依赖关系分析

### 模块依赖关系图

```
┌──────────────────────────────────────────────────────┐
│                  test (应用模块)                       │
│                                                        │
│  依赖:                                                 │
│  ├─ project(":duix-sdk")        [模块依赖]            │
│  ├─ androidx.core:core-ktx:1.12.0                    │
│  ├─ androidx.appcompat:appcompat:1.2.0               │
│  ├─ com.google.android.material:material:1.4.0       │
│  ├─ androidx.constraintlayout:constraintlayout:2.1.1 │
│  ├─ com.github.bumptech.glide:glide:4.12.0  [图片]   │
│  └─ com.squareup.okhttp3:okhttp:4.10.0      [网络]   │
└──────────────────────────────────────────────────────┘
                            ↓
┌──────────────────────────────────────────────────────┐
│                duix-sdk (SDK模块)                      │
│                                                        │
│  Java/Kotlin依赖:                                     │
│  ├─ androidx.appcompat:appcompat:1.6.1               │
│  ├─ androidx.activity:activity-ktx:1.7.2             │
│  └─ fileTree(dir: 'libs', include: ['*.jar', '*.aar'])│
│                                                        │
│  Native依赖 (CMake):                                  │
│  ├─ dhcore (静态库)                                   │
│  ├─ dhmfcc (静态库)                                   │
│  ├─ dhunet (静态库)                                   │
│  ├─ gjduix (动态库)                                   │
│  │                                                     │
│  └─ 第三方库:                                         │
│      ├─ OpenCV mobile 4.6.0                          │
│      ├─ NCNN 20231027                                │
│      ├─ ONNX Runtime                                 │
│      ├─ TurboJPEG                                    │
│      └─ libjpeg                                      │
└──────────────────────────────────────────────────────┘
```

### Java层依赖链

#### test模块主要类依赖

```
App.java
└─ 无外部依赖，纯Application类

MainActivity.kt
├─ duix-sdk依赖:
│   ├─ VirtualModelUtil (模型管理)
│   ├─ WelcomeActivity (欢迎页)
│   └─ WelcomeConfig (配置管理)
├─ UI组件:
│   ├─ LoadingDialog
│   └─ ModelSelectorDialog
└─ Android系统库

CallActivity.kt
├─ duix-sdk核心:
│   ├─ DUIX (主控类) ⭐
│   ├─ DUIXRenderer (渲染器)
│   ├─ RenderThread (渲染线程)
│   └─ Constant (常量)
├─ UI组件:
│   ├─ MotionAdapter
│   └─ AudioRecordDialog
├─ 第三方库:
│   └─ Glide (图片加载)
└─ Android系统库
```

#### duix-sdk核心类依赖

```
DUIX.java (⭐ SDK入口)
├─ RenderThread (渲染线程)
├─ RenderSink (渲染接口)
├─ ModelInfo (模型信息)
├─ Callback (回调接口)
└─ Constant (常量)
    ↓
RenderThread.java (⭐ 核心渲染线程)
├─ DuixNcnn (JNI接口)
├─ AudioPlayer (音频播放)
├─ ImageFrame (图像帧)
├─ AudioFrame (音频帧)
├─ RenderSink (渲染接收器)
└─ 各种Util工具类
    ↓
DUIXRenderer.java (OpenGL渲染器)
├─ ImageDrawer (图像绘制)
├─ TextureMatrix (纹理矩阵)
├─ OpenGLUtil (OpenGL工具)
└─ DUIXTextureView (纹理视图)
    ↓
DuixNcnn.java (JNI声明)
└─ Native方法声明
    ↓
[JNI边界]
    ↓
DuixJni.cpp (Native实现)
```

### Native层依赖链

```
gjduix.so (主动态库)
├─ 依赖静态库:
│   ├─ dhcore.a
│   ├─ dhmfcc.a
│   └─ dhunet.a
│
├─ 依赖第三方库:
│   ├─ libopencv_core.so
│   ├─ libopencv_imgproc.so
│   ├─ libncnn.so
│   ├─ libonnxruntime.so
│   ├─ libturbojpeg.a
│   └─ libjpeg.a
│
└─ 系统库:
    ├─ liblog.so (日志)
    ├─ libz.so (压缩)
    ├─ libm.so (数学)
    ├─ libpthread (线程)
    └─ libandroid.so (Android API)

────────────────────────────

dhcore.a (核心数据结构)
├─ 文件:
│   ├─ dh_mem.c (内存管理)
│   ├─ dh_data.cpp (数据结构)
│   └─ dh_que.cpp (队列)
└─ 依赖:
    ├─ libm.so
    ├─ libz.so
    └─ pthread

dhmfcc.a (音频特征提取)
├─ 文件:
│   ├─ dhpcm.cpp (PCM处理)
│   ├─ dhwenet.cpp (WeNet集成)
│   ├─ wenetai.cpp (AI接口)
│   ├─ AudioFFT.cpp (FFT)
│   ├─ iir_filter.cpp (滤波)
│   └─ mfcc.cpp (MFCC特征)
└─ 依赖:
    ├─ dhcore.a
    ├─ libz.so
    └─ libm.so

dhunet.a (AI推理)
├─ 文件:
│   ├─ munet.cpp (UNet推理)
│   ├─ malpha.cpp (Alpha处理)
│   ├─ blendgram.cpp (混合处理)
│   ├─ jmat.cpp (矩阵运算)
│   └─ face_utils.cpp (人脸工具)
└─ 依赖:
    ├─ dhcore.a
    ├─ dhmfcc.a
    ├─ libz.so
    └─ libm.so
```

### 第三方库详细说明

| 库名 | 版本 | 用途 | 依赖方式 |
|------|------|------|---------|
| **NCNN** | 20231027 | 神经网络推理引擎，用于AI模型推理 | 动态链接 (.so) |
| **OpenCV Mobile** | 4.6.0 | 图像处理库，用于图像变换、色彩转换等 | 动态链接 (.so) |
| **ONNX Runtime** | - | ONNX模型运行时，支持ONNX格式模型 | 动态链接 (.so) |
| **TurboJPEG** | - | 高性能JPEG编解码库 | 静态链接 (.a) |
| **libjpeg** | - | JPEG标准库 | 静态链接 (.a) |
| **Glide** | 4.12.0 | 图片加载库（test模块） | Gradle依赖 |
| **OkHttp** | 4.10.0 | HTTP客户端（test模块） | Gradle依赖 |
| **AndroidX** | 多版本 | Android支持库 | Gradle依赖 |

---

## 核心模块说明

### 1. DUIX核心模块

**位置**: `duix-sdk/src/main/java/ai/guiji/duix/sdk/client/DUIX.java`

**职责**: SDK主控类，统一对外API接口

**核心功能**:

```java
// 1. 初始化数字人
public void init()
// 检查模型文件 → 创建渲染线程 → Native初始化

// 2. PCM流式音频驱动
public void startPush()      // 开始推送
public void pushPcm(byte[])  // 推送PCM数据
public void stopPush()       // 停止推送

// 3. WAV文件播放
public void playAudio(String wavPath)
// 读取WAV文件 → 跳过44字节头 → 转为PCM推送

// 4. 停止音频
public boolean stopAudio()

// 5. 动作控制
public void startMotion(String name, boolean now)     // 指定动作
public void startRandomMotion(boolean now)            // 随机动作

// 6. 音量控制
public void setVolume(float volume)  // 0.0 ~ 1.0

// 7. 资源释放
public void release()
```

**依赖关系**:
- RenderThread: 渲染线程
- RenderSink: 渲染输出接口
- Callback: 事件回调

**回调事件**:
```java
CALLBACK_EVENT_INIT_READY        // 初始化完成
CALLBACK_EVENT_INIT_ERROR        // 初始化失败
CALLBACK_EVENT_AUDIO_PLAY_START  // 音频播放开始
CALLBACK_EVENT_AUDIO_PLAY_END    // 音频播放结束
CALLBACK_EVENT_AUDIO_PLAY_ERROR  // 音频播放错误
CALLBACK_EVENT_MOTION_START      // 动作播放开始
CALLBACK_EVENT_MOTION_END        // 动作播放结束
```

---

### 2. RenderThread渲染线程

**位置**: `duix-sdk/src/main/java/ai/guiji/duix/sdk/client/thread/RenderThread.java`

**职责**: 核心渲染线程，管理Native层交互和OpenGL渲染

**核心功能**:
- 音频队列管理
- Native层初始化和调用
- 帧渲染控制
- 音频播放控制
- 线程生命周期管理

**关键方法**:
```java
// Native接口调用
private native int duixInit(...)          // 初始化
private native int duixPushAudio(...)     // 推送音频
private native int duixRender(...)        // 渲染帧
private native void duixRelease()         // 释放资源

// 音频控制
public void startPush()                   // 开始接收音频
public void pushAudio(byte[] pcm)         // 推送音频到队列
public void stopPush()                    // 停止接收音频
public void stopPlayAudio()               // 停止播放

// 动作控制
public void startMotion(...)              // 开始动作
public void startRandomMotion()           // 随机动作

// 线程控制
public void run()                         // 渲染循环
public void stopPreview()                 // 停止渲染
```

**线程模型**:
```
RenderThread [独立线程]
├─ 音频队列 (ConcurrentQueue)
│   ├─ pushAudio() → 入队
│   └─ 渲染循环 → 出队
│
├─ 渲染循环 (while running)
│   ├─ 取出音频数据
│   ├─ Native推送 (duixPushAudio)
│   ├─ Native渲染 (duixRender)
│   ├─ 获取图像帧
│   ├─ 调用RenderSink.onFrame()
│   └─ 等待下一帧
│
└─ 状态管理
    ├─ isPushing (是否正在接收音频)
    ├─ isPlaying (是否正在播放)
    └─ stopFlag (停止标志)
```

---

### 3. DUIXRenderer渲染器

**位置**: `duix-sdk/src/main/java/ai/guiji/duix/sdk/client/render/DUIXRenderer.java`

**职责**: OpenGL ES渲染器，负责将图像帧渲染到屏幕

**核心功能**:
```java
// GLSurfaceView.Renderer接口实现
public void onSurfaceCreated(GL10, EGLConfig)   // Surface创建
public void onSurfaceChanged(GL10, int, int)    // Surface尺寸变化
public void onDrawFrame(GL10)                   // 绘制帧

// RenderSink接口实现
public void onFrame(ImageFrame frame)           // 接收新帧
public void requestRender()                     // 请求渲染
```

**渲染流程**:
```
ImageFrame (Native生成)
    ↓
RenderThread.onFrame()
    ↓
DUIXRenderer.onFrame()
    ├─ 保存ImageFrame
    └─ 请求GLSurfaceView渲染
    ↓
onDrawFrame() [GL线程]
    ├─ 取出ImageFrame
    ├─ 上传纹理到GPU
    ├─ ImageDrawer.draw()
    └─ SwapBuffers显示
```

**支持特性**:
- RGBA格式支持（透明通道）
- 双缓冲渲染
- 自适应尺寸
- 背景透明渲染

---

### 4. VirtualModelUtil模型工具

**位置**: `duix-sdk/src/main/java/ai/guiji/duix/sdk/client/VirtualModelUtil.java`

**职责**: 数字人模型下载和管理

**核心功能**:
```java
// 模型检查
public static boolean checkBaseConfig(Context)
public static boolean checkModel(Context, String url)

// 模型下载
public static void baseConfigDownload(Context, String url, Callback)
public static void modelDownload(Context, String url, Callback)

// 回调接口
interface ModelDownloadCallback {
    void onDownloadProgress(String url, long current, long total)
    void onUnzipProgress(String url, long current, long total)
    void onDownloadComplete(String url, File dir)
    void onDownloadFail(String url, int code, String msg)
}
```

**模型目录结构**:
```
/sdcard/Android/data/<package>/files/duix/
├── model/
│   ├── gj_dh_res/              # 基础配置（必需）
│   │   ├── *.param             # NCNN模型参数
│   │   ├── *.bin               # NCNN模型权重
│   │   └── *.onnx              # ONNX模型
│   │
│   ├── <model_name>/           # 具体数字人模型
│   │   ├── model.json          # 模型配置
│   │   ├── texture/            # 纹理资源
│   │   ├── motion/             # 动作数据
│   │   └── audio/              # 音频资源
│   │
│   └── tmp/                    # 下载标记
│       ├── gj_dh_res
│       └── <model_name>
```

**下载流程**:
```
用户请求下载
    ↓
FileDownloader.download()
    ├─ OkHttp请求
    ├─ 分块下载
    ├─ 进度回调: onDownloadProgress()
    └─ 下载完成
    ↓
ZipUtil.unzip()
    ├─ 解压ZIP文件
    ├─ 进度回调: onUnzipProgress()
    └─ 解压完成
    ↓
创建标记文件 (tmp/<model_name>)
    ↓
回调: onDownloadComplete()
```

---

### 5. Welcome欢迎页模块

**位置**: `duix-sdk/src/main/java/ai/guiji/duix/sdk/welcome/`

**文件组成**:
- `WelcomeActivity.kt`: 欢迎页Activity
- `WelcomeConfig.kt`: 配置管理
- `WelcomeIntegrationExample.kt`: 集成示例
- `assets/welcome/welcome.html`: 欢迎页UI界面 (已于2025-10-02完成现代化美化升级)

**设计架构**: WebView + HTML/CSS/JS + Tailwind CSS

**功能特性**:
- 本地/云端模式选择
- 首次启动引导
- 用户选择持久化
- 版本管理
- 现代化UI设计与流畅动画效果

**UI设计特性** (2025-10-02升级):
- ✅ **渐变背景**: 动态渐变背景，15秒循环动画，营造科技感氛围
- ✅ **毛玻璃效果**: 卡片采用backdrop-filter实现背景模糊效果
- ✅ **流畅动画**: 页面加载动画(fadeIn/fadeInDown/fadeInUp)、悬浮效果、点击反馈
- ✅ **呼吸效果**: Logo光环2秒呼吸动画，增强视觉吸引力
- ✅ **装饰元素**: 3个浮动几何形状，增强层次感
- ✅ **交互反馈**: 悬浮时卡片上移5px并缩放1.02倍，点击时缩放0.98倍
- ✅ **响应式设计**: 支持小屏(≤640px)、中屏(641-1024px)、大屏自适应
- ✅ **高性能**: 使用GPU加速的CSS属性(transform/opacity)，避免触发重排

**颜色方案**:
- 主背景渐变: `#667eea` → `#764ba2` → `#f093fb`
- 本地模式图标: `#667eea` → `#764ba2` (紫色渐变)
- 云端模式图标: `#f093fb` → `#f5576c` (粉色渐变)
- 卡片背景: `rgba(255,255,255,0.95)` (半透明白色)

**WebView交互**:
```javascript
// HTML/JS调用Android
window.AndroidBridge.onLocalChoice()  // 选择本地模式
window.AndroidBridge.onCloudChoice()  // 选择云端模式
window.AndroidBridge.onPageLoaded()   // 页面加载完成

// Android响应
@JavascriptInterface
fun onLocalChoice() {
    // 保存选择 → 设置结果 → 关闭页面
}
```

**配置管理**:
```kotlin
// SharedPreferences存储
KEY_USER_CHOICE          // 用户选择
KEY_WELCOME_VERSION      // 欢迎页版本
KEY_CHOICE_TIMESTAMP     // 选择时间戳

// 用户选择枚举
enum class UserChoice {
    NONE,    // 未选择
    LOCAL,   // 本地模式
    CLOUD    // 云端模式
}
```

**相关文档**: `docs/欢迎页面界面美化-2025-10-02.md`

---

### 6. Native核心模块详解

#### 6.1 gjduix核心 (duix/)

**文件**: `gjduix.cpp`, `gjsimp.cpp`

**职责**: Native层主控逻辑

**核心函数**:
```cpp
// 初始化
int gjduix_init(const char* model_path, callback_func cb);

// 音频处理
int gjduix_push_audio(const uint8_t* pcm, int len);

// 渲染
int gjduix_render(uint8_t* rgba_out, int* width, int* height);

// 动作控制
int gjduix_start_motion(const char* motion_name, bool immediate);
int gjduix_random_motion();

// 清理
void gjduix_release();
```

**内部流程**:
```
gjduix_init()
├─ 加载模型配置
├─ 初始化dhmfcc (音频模块)
├─ 初始化dhunet (AI模块)
├─ 加载NCNN/ONNX模型
└─ 准备渲染资源

gjduix_push_audio()
├─ PCM数据入队
├─ dhmfcc提取MFCC特征
├─ AI模型推理生成混合权重
└─ 更新渲染参数

gjduix_render()
├─ dhunet推理生成图像
├─ blendgram混合处理
├─ alpha通道处理
└─ 输出RGBA图像
```

#### 6.2 dhcore核心库 (dhcore/)

**职责**: 基础数据结构和内存管理

**主要组件**:
- `dh_mem`: 内存池管理
- `dh_data`: 数据缓冲区
- `dh_que`: 线程安全队列
- `concurrentqueue`: 无锁并发队列
- `readerwriterqueue`: 读写队列

**特点**:
- 无锁并发
- 高性能队列
- 内存复用
- 线程安全

#### 6.3 dhmfcc音频模块 (dhmfcc/)

**职责**: 音频特征提取

**处理流程**:
```
PCM音频 (16kHz, 16bit, Mono)
    ↓
dhpcm.cpp (预处理)
    ├─ 音频分帧
    ├─ 预加重
    └─ 窗函数
    ↓
AudioFFT.cpp (频域分析)
    ├─ FFT变换
    └─ 功率谱
    ↓
iir_filter.cpp (滤波)
    ├─ Mel滤波器组
    └─ 频率映射
    ↓
mfcc.cpp (特征提取)
    ├─ DCT变换
    └─ MFCC系数
    ↓
dhwenet.cpp (AI增强)
    ├─ WeNet模型
    └─ 特征优化
    ↓
输出: 音频特征向量
```

**关键参数**:
- 采样率: 16000Hz
- 帧长: 25ms
- 帧移: 10ms
- MFCC维度: 通常13维
- Mel滤波器数: 40

#### 6.4 dhunet AI模块 (dhunet/)

**职责**: AI模型推理和图像生成

**核心组件**:
```cpp
munet.cpp/h         // UNet模型推理
├─ 加载NCNN/ONNX模型
├─ 前向推理
└─ 输出图像特征

malpha.cpp/h        // Alpha通道处理
├─ 透明度混合
└─ 边缘抗锯齿

blendgram.cpp/h     // 混合图处理
├─ 多层混合
└─ 动态权重

jmat.cpp/h          // 矩阵运算
├─ 矩阵乘法
├─ 仿射变换
└─ 插值

face_utils.cpp/h    // 人脸工具
├─ 关键点检测
└─ 面部区域定位
```

**AI推理流程**:
```
音频特征 + 当前帧状态
    ↓
munet.cpp (UNet推理)
    ├─ NCNN前向推理
    ├─ 生成混合权重
    └─ 生成变形参数
    ↓
blendgram.cpp (混合处理)
    ├─ 基础纹理
    ├─ 表情纹理
    ├─ 动作纹理
    └─ 按权重混合
    ↓
jmat.cpp (几何变换)
    ├─ 网格变形
    └─ 仿射变换
    ↓
malpha.cpp (Alpha处理)
    ├─ 透明度合成
    └─ 边缘优化
    ↓
输出: RGBA图像 (支持透明)
```

---

## 文件功能说明

### Java/Kotlin核心类功能详解

#### SDK核心包 (duix-sdk/sdk/client/)

| 文件 | 类型 | 主要功能 | 关键方法 |
|------|------|---------|---------|
| **DUIX.java** | 主控类 | SDK统一入口，管理渲染线程和模型生命周期 | `init()`, `playAudio()`, `startMotion()`, `release()` |
| **Callback.java** | 接口 | 事件回调接口定义 | `onEvent(int event, String msg, Object info)` |
| **Constant.java** | 常量类 | 定义所有事件常量和配置常量 | 事件码、状态码定义 |
| **VirtualModelUtil.java** | 工具类 | 模型下载、解压、校验管理 | `checkModel()`, `modelDownload()`, `baseConfigDownload()` |

#### 音频包 (audio/)

| 文件 | 功能 | 说明 |
|------|------|------|
| **AudioPlayer.java** | 音频播放器 | 使用AudioTrack播放PCM音频，支持音量控制和播放控制 |

#### 数据模型包 (bean/)

| 文件 | 功能 | 字段 |
|------|------|------|
| **ImageFrame.java** | 图像帧数据 | `byte[] data`, `int width`, `int height`, `int format` |
| **AudioFrame.java** | 音频帧数据 | `byte[] pcm`, `int length`, `long timestamp` |

#### 网络包 (net/)

| 文件 | 功能 | 说明 |
|------|------|------|
| **FileDownloader.java** | 文件下载器 | 基于OkHttp的断点续传下载器，支持进度回调 |
| **DownloadZipService.java** | ZIP下载服务 | 专门用于下载和处理ZIP格式的模型文件 |

#### 渲染包 (render/)

| 文件 | 功能 | 说明 |
|------|------|------|
| **DUIXRenderer.java** | OpenGL渲染器 | 实现GLSurfaceView.Renderer，负责OpenGL渲染管线 |
| **DUIXTextureView.java** | 纹理视图 | 自定义TextureView，支持透明背景和硬件加速 |
| **ImageDrawer.java** | 图像绘制器 | 封装OpenGL绘制逻辑，管理Shader和纹理 |
| **TextureMatrix.java** | 纹理矩阵 | 纹理坐标变换矩阵管理 |
| **RenderSink.java** | 渲染接口 | 渲染数据接收器接口，解耦渲染和数据源 |

#### 线程包 (thread/)

| 文件 | 功能 | 说明 |
|------|------|------|
| **RenderThread.java** | 渲染线程 | 核心渲染线程，管理Native交互、音频队列、帧渲染 |

#### 工具包 (util/)

| 文件 | 功能 | 主要方法 |
|------|------|---------|
| **DeviceUtils.java** | 设备信息 | `getCPUInfo()`, `getMemoryInfo()`, `getGPUInfo()` |
| **FileUtil.java** | 文件操作 | `copyFile()`, `deleteDir()`, `getFileSize()` |
| **Logger.java** | 日志工具 | `d()`, `i()`, `w()`, `e()` - 统一日志接口 |
| **MD5Util.java** | MD5计算 | `getMD5(File)`, `getMD5(String)` - 文件校验 |
| **OpenGLUtil.java** | OpenGL工具 | `createProgram()`, `loadShader()`, `checkError()` |
| **SystemUtils.java** | 系统工具 | `getSDKVersion()`, `getABI()`, `isTablet()` |
| **ZipUtil.java** | ZIP工具 | `unzip()`, `zipFiles()` - 压缩解压 |

#### 欢迎页包 (welcome/)

| 文件 | 功能 | 说明 |
|------|------|------|
| **WelcomeActivity.kt** | 欢迎页Activity | WebView加载欢迎页，处理用户选择，支持动画效果 |
| **WelcomeConfig.kt** | 配置管理 | SharedPreferences持久化用户选择和版本信息 |
| **WelcomeIntegrationExample.kt** | 集成示例 | 展示如何在应用中集成欢迎页功能 |

#### 欢迎页资源 (assets/welcome/)

| 文件 | 功能 | 说明 |
|------|------|------|
| **welcome.html** | 欢迎页UI界面 | 现代化设计，包含动态渐变背景、毛玻璃卡片、流畅动画、呼吸光环效果 (2025-10-02美化升级) |
| **js/welcome.js** | 交互脚本 | 处理用户点击事件，通过AndroidBridge与原生层通信 |
| **css/tailwind.min.css** | Tailwind CSS | 提供基础样式框架 |

**welcome.html 核心特性**:
- **渐变背景**: 紫色系动态渐变(`#667eea` → `#764ba2` → `#f093fb`)，15秒循环
- **毛玻璃卡片**: `backdrop-filter: blur(10px)` + 95%白色背景
- **页面加载动画**: fadeInDown(Logo/标题) + fadeInUp(卡片) + fadeIn(底部)
- **交互反馈**: 悬浮上浮5px + 缩放1.02倍，点击缩放0.98倍
- **呼吸光环**: Logo背景2秒pulse动画
- **装饰元素**: 3个浮动半透明圆形，20秒float动画
- **响应式设计**: ≤640px小屏、641-1024px中屏自适应
- **性能优化**: GPU加速属性(transform/opacity)，避免重排
- **浏览器兼容**: 支持Chrome/Safari/Android WebView (Android 5+)

---

### Native核心文件功能详解

#### Android JNI层 (android/)

| 文件 | 功能 | 关键函数 |
|------|------|---------|
| **DuixJni.cpp** | JNI接口实现 | `Java_*_duixInit()`, `Java_*_duixPushAudio()`, `Java_*_duixRender()` |
| **JniHelper.cpp/h** | JNI辅助工具 | 类型转换、异常处理、引用管理 |
| **Log.cpp/h** | Native日志 | `LOGD()`, `LOGI()`, `LOGW()`, `LOGE()` 宏定义 |

#### DUIX核心 (duix/)

| 文件 | 功能 | 说明 |
|------|------|------|
| **gjduix.cpp/h** | DUIX主实现 | 模型加载、音频处理、图像渲染、动作控制的完整实现 |
| **gjsimp.cpp** | 简化接口 | 提供更简单的C接口封装，便于其他语言调用 |

#### 核心库 (dhcore/)

| 文件 | 功能 | 说明 |
|------|------|------|
| **dh_mem.c/h** | 内存管理 | 内存池、对象池、智能指针 |
| **dh_data.cpp/h** | 数据结构 | 动态数组、缓冲区管理 |
| **dh_que.cpp/h** | 队列实现 | 线程安全队列、环形缓冲区 |
| **concurrentqueue.h** | 无锁队列 | 高性能并发队列（第三方） |
| **readerwriterqueue.h** | 读写队列 | 单生产者单消费者无锁队列 |

#### 音频模块 (dhmfcc/)

| 文件 | 功能 | 说明 |
|------|------|------|
| **dhpcm.cpp/h** | PCM处理 | PCM音频预处理、分帧、窗函数 |
| **dhwenet.cpp/h** | WeNet集成 | 集成WeNet语音识别模型 |
| **wenetai.cpp/h** | AI接口 | WeNet推理接口封装 |
| **AudioFFT.cpp** | FFT变换 | 快速傅里叶变换实现 |
| **iir_filter.cpp** | IIR滤波 | 无限脉冲响应滤波器 |
| **mfcc.cpp** | MFCC提取 | Mel频率倒谱系数提取 |

#### AI推理模块 (dhunet/)

| 文件 | 功能 | 说明 |
|------|------|------|
| **munet.cpp/h** | UNet推理 | U-Net模型推理，生成图像和权重 |
| **malpha.cpp/h** | Alpha处理 | 透明通道处理、Alpha混合 |
| **blendgram.cpp/h** | 混合处理 | 多层纹理混合、动态权重 |
| **jmat.cpp/h** | 矩阵运算 | 矩阵运算、仿射变换 |
| **face_utils.cpp/h** | 人脸工具 | 人脸关键点、面部区域处理 |

#### 加密模块 (aes/)

| 文件 | 功能 | 说明 |
|------|------|------|
| **aes_core.c** | AES核心 | AES加密算法核心实现 |
| **aes_cbc.c** | CBC模式 | 密码分组链接模式 |
| **aes_ecb.c** | ECB模式 | 电子密码本模式 |
| **gj_aes.c/h** | 自定义AES | 封装的AES接口 |
| **gaes_stream.cc/h** | AES流 | 流式AES加解密 |
| **base64.c/h** | Base64 | Base64编解码 |

---

### Test模块文件功能

#### Activity层 (ui/activity/)

| 文件 | 功能 | 说明 |
|------|------|------|
| **MainActivity.kt** | 主界面 | 模型选择、下载、配置，启动数字人播放 |
| **CallActivity.kt** | 播放界面 | 数字人渲染、音频播放、动作控制、调试信息 |
| **BaseActivity.java** | 基础Activity | 权限管理、生命周期管理 |

#### UI组件 (ui/)

| 目录/文件 | 功能 | 说明 |
|----------|------|------|
| **adapter/** | 适配器 | RecyclerView适配器 |
| - ModelSelectorAdapter.kt | 模型选择 | 显示可用模型列表 |
| - MotionAdapter.kt | 动作选择 | 显示可用动作列表 |
| **dialog/** | 对话框 | 各类对话框 |
| - LoadingDialog.kt | 加载对话框 | 显示下载/加载进度 |
| - AudioRecordDialog.kt | 录音对话框 | 音频录制和播放 |
| - ModelSelectorDialog.kt | 模型选择 | 模型选择弹窗 |

#### 其他模块 (test/)

| 目录 | 功能 | 主要文件 |
|------|------|---------|
| **audio/** | 音频录制 | AudioRecorder.java - Android录音器封装 |
| **net/** | 网络下载 | SyncDownloadFile.java - 同步下载 |
| **render/** | 调试渲染 | DebugSink.java - 调试用渲染接收器 |
| **service/** | 服务层 | StorageService.java - 存储管理服务 |
| **util/** | 工具类 | 字符串、系统、ZIP工具 |

---

## 目录解耦分析

### 整体架构评估

项目采用**模块化分层架构**，整体解耦程度**较好**，但存在一些可以优化的地方。

#### ✅ 优点

1. **模块独立性强**
   - `duix-sdk`和`test`模块完全独立
   - SDK可以独立编译为AAR发布
   - test模块仅依赖SDK公开API

2. **层次划分清晰**
   ```
   Application Layer (test)
        ↓ [依赖]
   SDK Layer (duix-sdk)
        ↓ [JNI]
   Native Layer (C++)
        ↓ [链接]
   Third-Party Libraries
   ```

3. **功能模块化**
   - 音频、渲染、网络、工具各自独立包
   - 每个模块职责单一
   - 模块间通过接口通信

4. **接口抽象良好**
   - `Callback` - 事件回调接口
   - `RenderSink` - 渲染数据接收接口
   - `ModelDownloadCallback` - 下载回调接口

#### ⚠️  存在的耦合问题

1. **DUIX类职责过重**
   ```
   DUIX.java (300+ lines)
   ├─ 模型管理
   ├─ 线程管理
   ├─ 音频控制
   ├─ 动作控制
   ├─ 音量控制
   └─ 生命周期管理
   ```

   **建议**: 拆分为：
   - `DUIXCore` - 核心初始化
   - `DUIXAudioController` - 音频控制
   - `DUIXMotionController` - 动作控制
   - `DUIXLifecycleManager` - 生命周期

2. **RenderThread职责过多**
   ```
   RenderThread.java (800+ lines)
   ├─ 线程管理
   ├─ 音频队列
   ├─ Native调用
   ├─ 渲染控制
   ├─ 动作管理
   └─ 回调处理
   ```

   **建议**: 拆分为：
   - `AudioQueueManager` - 音频队列
   - `NativeInterface` - Native调用封装
   - `RenderController` - 渲染控制
   - `RenderThread` - 仅负责线程循环

3. **Welcome模块耦合**
   - `WelcomeActivity`包含业务逻辑
   - WebView交互代码分散

   **建议**:
   - 提取`WelcomeViewModel`处理业务
   - 封装`WebViewBridge`统一交互

4. **Native层缺少抽象**
   - `gjduix.cpp`直接调用各子模块
   - 模块间直接依赖

   **建议**:
   - 定义接口层（如`IAudioProcessor`, `IRenderer`）
   - 通过工厂模式创建实例

#### 📊 解耦度评分

| 层级 | 解耦度 | 评分 | 说明 |
|------|--------|------|------|
| **模块级** | 优秀 | ⭐⭐⭐⭐⭐ | SDK和App完全独立 |
| **包级** | 良好 | ⭐⭐⭐⭐ | 功能模块划分清晰 |
| **类级** | 一般 | ⭐⭐⭐ | 部分类职责过重 |
| **方法级** | 良好 | ⭐⭐⭐⭐ | 方法功能单一 |
| **Native** | 一般 | ⭐⭐⭐ | 缺少接口抽象 |

**综合评分**: ⭐⭐⭐⭐ (4/5星)

---

### 依赖方向分析

```
test模块依赖关系:
test/
├─ [✅正向] → duix-sdk (模块依赖)
├─ [✅正向] → AndroidX (系统库)
├─ [✅正向] → Glide (第三方)
└─ [✅正向] → OkHttp (第三方)

duix-sdk依赖关系:
duix-sdk/
├─ [✅正向] → AndroidX (系统库)
├─ [✅正向] → Native libs (JNI)
└─ [❌无依赖] test模块 ← 正确！

Native依赖关系:
gjduix.so
├─ [✅正向] → dhcore, dhmfcc, dhunet (静态库)
├─ [✅正向] → NCNN, OpenCV, ONNX (第三方)
└─ [✅正向] → 系统库
```

**✅ 依赖方向合理，无循环依赖**

---

### 改进建议

#### 1. 引入MVVM架构 (UI层)

```kotlin
// 当前
CallActivity → 直接操作 → DUIX

// 建议
CallActivity → CallViewModel → DUIXRepository → DUIX
         ↓
      LiveData
```

#### 2. 使用依赖注入

```kotlin
// 当前
val duix = DUIX(context, modelUrl, renderer, callback)

// 建议 (Dagger/Hilt)
@Inject
lateinit var duixFactory: DUIXFactory

val duix = duixFactory.create(modelUrl, renderer, callback)
```

#### 3. 统一状态管理

```kotlin
sealed class DUIXState {
    object Idle : DUIXState()
    object Initializing : DUIXState()
    data class Ready(val modelInfo: ModelInfo) : DUIXState()
    data class Playing(val progress: Float) : DUIXState()
    data class Error(val code: Int, val msg: String) : DUIXState()
}
```

#### 4. 事件总线解耦

```kotlin
// 替代直接Callback
EventBus.post(DUIXEvent.InitReady(modelInfo))
EventBus.post(DUIXEvent.PlayStart())
```

---

## 待完成事项(TODO)

### 1. MainActivity.kt 中的TODO

**文件**: `test/src/main/java/ai/guiji/duix/test/ui/activity/MainActivity.kt`

| 行号 | TODO内容 | 优先级 | 说明 |
|------|---------|--------|------|
| 35 | 可以在这里预加载本地资源或设置相关配置 | 中 | 本地模式选择后的初始化逻辑 |
| 39 | 可以在这里检查网络连接或设置云端配置 | 中 | 云端模式选择后的初始化逻辑 |

**建议实现**:
```kotlin
// 本地模式初始化
when (userChoice) {
    UserChoice.LOCAL -> {
        // 预加载本地模型
        preloadLocalModels()
        // 检查存储空间
        checkStorageSpace()
        // 设置离线模式标志
        AppConfig.setOfflineMode(true)
    }
    UserChoice.CLOUD -> {
        // 检查网络连接
        if (!NetworkUtil.isConnected()) {
            showNetworkError()
        }
        // 设置云端API配置
        CloudConfig.init()
        // 预加载云端资源列表
        fetchCloudResourceList()
    }
}
```

---

### 2. WelcomeConfig.kt 中的TODO

**文件**: `duix-sdk/src/main/java/ai/guiji/duix/sdk/welcome/WelcomeConfig.kt`

| 行号 | TODO内容 | 优先级 | 说明 |
|------|---------|--------|------|
| 14-17 | 后续可扩展的功能<br>- 支持多用户配置<br>- 配置导入导出<br>- 在线配置同步 | 低 | 扩展功能规划 |
| 34 | 支持版本更新检测 | 中 | 欢迎页版本管理机制 |
| 73 | 添加选择统计和分析 | 低 | 用户行为分析 |
| 128 | 检查版本更新是否需要重新显示欢迎页面 | 中 | 版本更新逻辑 |
| 159 | 集成分析SDK，记录用户选择行为 | 低 | 数据统计集成 |

**建议实现**:

```kotlin
// 1. 版本更新检测
fun shouldShowWelcomePage(context: Context): Boolean {
    val savedVersion = getWelcomeVersion(context)
    val currentVersion = CURRENT_WELCOME_VERSION

    if (savedVersion < currentVersion) {
        // 版本更新，重新显示欢迎页
        return true
    }

    return getUserChoice(context) == CHOICE_NONE
}

// 2. 用户行为分析
private fun logUserChoice(choice: String) {
    // 集成Firebase Analytics
    FirebaseAnalytics.getInstance(context).logEvent("welcome_choice") {
        param("choice_type", choice)
        param("timestamp", System.currentTimeMillis())
        param("app_version", BuildConfig.VERSION_NAME)
    }
}

// 3. 配置导入导出
fun exportConfig(context: Context): String {
    val config = mapOf(
        "userChoice" to getUserChoice(context),
        "timestamp" to getChoiceTimestamp(context),
        "version" to getWelcomeVersion(context)
    )
    return Json.encodeToString(config)
}

fun importConfig(context: Context, configJson: String) {
    val config = Json.decodeFromString<Map<String, Any>>(configJson)
    // 恢复配置...
}
```

---

### 3. WelcomeActivity.kt 中的TODO

**文件**: `duix-sdk/src/main/java/ai/guiji/duix/sdk/welcome/WelcomeActivity.kt`

| 行号 | TODO内容 | 优先级 | 说明 |
|------|---------|--------|------|
| 28-31 | 后续可扩展的功能<br>- 页面加载进度显示<br>- 网络状态检测<br>- 错误重试机制<br>- 主题切换支持 | 中 | UI功能扩展 |
| 173 | 添加页面加载完成的动画效果 | 低 | UI优化 |
| 194 | 添加错误处理和重试机制 | 高 | 错误处理 |
| 202 | 添加调试日志收集 | 中 | 日志管理 |
| 245 | 添加重试按钮或fallback UI | 高 | 用户体验 |
| 272 | 可以在这里添加页面加载完成的额外处理 | 低 | 扩展点 |
| 300 | 添加Activity切换动画 | 低 | UI效果 |

**建议实现**:

```kotlin
// 1. 错误处理和重试机制
private fun handlePageError(errorCode: Int, description: String?) {
    runOnUiThread {
        AlertDialog.Builder(this)
            .setTitle("加载失败")
            .setMessage("页面加载失败: $description\n是否重试？")
            .setPositiveButton("重试") { _, _ ->
                webView.reload()
            }
            .setNegativeButton("退出") { _, _ ->
                finish()
            }
            .setCancelable(false)
            .show()
    }
}

// 2. 加载进度显示
private fun setupLoadingProgress() {
    val progressBar = findViewById<ProgressBar>(R.id.progressBar)

    webView.webChromeClient = object : WebChromeClient() {
        override fun onProgressChanged(view: WebView?, newProgress: Int) {
            progressBar.progress = newProgress
            if (newProgress == 100) {
                progressBar.visibility = View.GONE
            }
        }
    }
}

// 3. 网络状态检测
private fun checkNetworkState() {
    if (!NetworkUtil.isConnected(this)) {
        showOfflineDialog()
    }
}

private fun showOfflineDialog() {
    AlertDialog.Builder(this)
        .setTitle("网络未连接")
        .setMessage("欢迎页面需要网络连接才能加载")
        .setPositiveButton("前往设置") { _, _ ->
            startActivity(Intent(Settings.ACTION_WIFI_SETTINGS))
        }
        .setNegativeButton("继续") { _, _ ->
            // 加载本地fallback页面
            loadFallbackPage()
        }
        .show()
}
```

---

### 4. WelcomeIntegrationExample.kt 中的TODO

**文件**: `duix-sdk/src/main/java/ai/guiji/duix/sdk/welcome/WelcomeIntegrationExample.kt`

| 行号 | TODO内容 | 优先级 | 说明 |
|------|---------|--------|------|
| 53 | 在这里添加本地数字人初始化逻辑 | 中 | 本地模式初始化 |
| 58 | 在这里添加云端数字人初始化逻辑 | 中 | 云端模式初始化 |
| 76 | 启动本地数字人相关功能 | 中 | 本地功能启动 |
| 81 | 启动云端数字人相关功能 | 中 | 云端功能启动 |
| 114 | 在这里可以设置一些全局配置 | 低 | 全局配置 |
| 124-130 | 在这里添加本地数字人的初始化逻辑 | 中 | 本地初始化详细实现 |
| 137-143 | 在这里添加云端数字人的初始化逻辑 | 中 | 云端初始化详细实现 |

**这些TODO是示例代码，供开发者参考实现**

---

### 5. DUIXTextureView.java 中的TODO

**文件**: `duix-sdk/src/main/java/ai/guiji/duix/sdk/client/render/DUIXTextureView.java`

| 行号 | TODO内容 | 优先级 | 说明 |
|------|---------|--------|------|
| 1735 | implement a fairness policy | 低 | EGL上下文公平性策略 |

**说明**: 这是GLSurfaceView相关的底层实现，暂时不影响功能

---

### TODO统计

| 模块 | TODO数量 | 高优先级 | 中优先级 | 低优先级 |
|------|---------|---------|---------|---------|
| **MainActivity** | 2 | 0 | 2 | 0 |
| **WelcomeConfig** | 5 | 0 | 2 | 3 |
| **WelcomeActivity** | 7 | 2 | 2 | 3 |
| **WelcomeExample** | 7 | 0 | 5 | 2 |
| **DUIXTextureView** | 1 | 0 | 0 | 1 |
| **总计** | **22** | **2** | **11** | **9** |

---

### 建议实现顺序

#### Phase 1: 高优先级 (必须完成)

1. ✅ WelcomeActivity错误处理和重试机制 (line 194, 245)
   - 用户体验关键
   - 防止因网络问题导致应用崩溃

#### Phase 2: 中优先级 (重要功能)

2. ✅ 模式选择后的初始化逻辑 (MainActivity line 35, 39)
   - 完善本地/云端模式的初始化流程

3. ✅ 版本更新检测机制 (WelcomeConfig line 34, 128)
   - 支持欢迎页版本迭代

4. ✅ 日志收集和调试 (WelcomeActivity line 202)
   - 便于问题排查

5. ✅ 本地/云端模式完整初始化 (WelcomeExample)
   - 提供完整的集成示例

#### Phase 3: 低优先级 (优化功能)

6. ⏳ UI动画和效果 (WelcomeActivity line 173, 300)
   - 提升用户体验

7. ⏳ 数据统计分析 (WelcomeConfig line 73, 159)
   - 用户行为分析

8. ⏳ 配置扩展功能 (WelcomeConfig line 14-17)
   - 多用户、导入导出等高级功能

---

## 技术栈

### 开发工具链

| 工具 | 版本 | 用途 |
|------|------|------|
| **Android Studio** | Giraffe 2022.3.1+ | IDE |
| **Gradle** | 8.1.2 | 构建系统 |
| **CMake** | 4.1.0+ | Native构建 |
| **NDK** | 23.1.7779620 | Native开发 |
| **Kotlin** | 1.8.10 | 主开发语言 |
| **Java** | 17 | JDK版本 |

---

### Android技术栈

#### 核心框架

```
AndroidX
├─ androidx.core:core-ktx (Kotlin扩展)
├─ androidx.appcompat (兼容性支持)
├─ androidx.activity (Activity KTX)
├─ androidx.fragment (Fragment支持)
└─ androidx.constraintlayout (约束布局)
```

#### UI组件

```
Material Design
├─ com.google.android.material:material:1.4.0
└─ 使用组件: Button, EditText, RecyclerView等
```

#### 图形渲染

```
OpenGL ES 2.0
├─ GLSurfaceView (系统自带)
├─ TextureView (支持透明背景)
├─ EGL配置: RGBA_8888, Depth 16
└─ Shader: GLSL ES 2.0
```

---

### Native技术栈

#### C++标准

```
C++ 17
├─ 编译选项: -std=c++17
├─ 特性: auto, lambda, smart pointers
└─ 异常支持: -fexceptions
```

#### AI/ML框架

```
NCNN (神经网络)
├─ 版本: 20231027
├─ 架构: arm64-v8a, armeabi-v7a
├─ 特性: Vulkan支持
└─ 用途: 主要推理引擎

ONNX Runtime
├─ 用途: ONNX模型运行时
├─ 格式: .onnx模型
└─ 集成: 动态链接

WeNet (语音识别)
└─ 用途: 音频特征增强
```

#### 图像处理

```
OpenCV Mobile
├─ 版本: 4.6.0
├─ 模块: core, imgproc, highgui
└─ 用途: 图像变换、色彩转换

TurboJPEG
└─ 用途: 高性能JPEG编解码
```

#### 音频处理

```
自研音频处理
├─ AudioFFT: FFT变换
├─ MFCC: Mel频率倒谱系数
├─ IIR Filter: 滤波器
└─ PCM: 16kHz, 16bit, Mono
```

---

### 第三方库

#### Java/Kotlin

```gradle
// 图片加载
implementation 'com.github.bumptech.glide:glide:4.12.0'

// 网络请求
implementation 'com.squareup.okhttp3:okhttp:4.10.0'
```

#### Native

```cmake
# 神经网络
find_package(ncnn REQUIRED)
target_link_libraries(gjduix ncnn)

# 图像处理
find_package(OpenCV REQUIRED core imgproc)
target_link_libraries(gjduix ${OpenCV_LIBS})

# ONNX
add_library(onnx-lib SHARED IMPORTED)
target_link_libraries(gjduix onnx-lib)

# JPEG
target_link_libraries(gjduix turbojpeg libjpeg)
```

---

### 架构模式

```
应用层:
├─ MVC (部分Activity)
└─ MVP (部分Dialog)

SDK层:
├─ 观察者模式 (Callback)
├─ 单例模式 (DUIXRenderer)
├─ 工厂模式 (VirtualModelUtil)
└─ 策略模式 (RenderSink)

Native层:
├─ 管道模式 (音频处理链)
├─ 生产者-消费者 (音频队列)
└─ 对象池模式 (内存管理)
```

---

### 并发模型

```
Java层:
├─ ExecutorService (线程池)
├─ HandlerThread (后台线程)
└─ RenderThread (自定义渲染线程)

Native层:
├─ std::thread (C++线程)
├─ pthread (POSIX线程)
└─ 无锁队列 (ConcurrentQueue)
```

---

## 构建与部署

### 开发环境配置

#### 1. 必需工具

```bash
# 检查环境
java -version          # 需要JDK 17
cmake --version        # 需要CMake 3.18.1+
ndk-build --version    # NDK 23.1.7779620

# Android Studio配置
File -> Settings -> Build, Execution, Deployment
  -> Gradle
    -> Gradle JDK: 选择JDK 17
```

#### 2. NDK配置

```bash
# 在local.properties中配置NDK路径
ndk.dir=C\:\\Users\\<username>\\AppData\\Local\\Android\\Sdk\\ndk\\23.1.7779620

# 或使用环境变量
export ANDROID_NDK_HOME=/path/to/ndk/23.1.7779620
```

#### 3. 依赖配置

项目使用阿里云Maven镜像加速：

```gradle
// build.gradle (根级)
repositories {
    maven { url 'https://maven.aliyun.com/repository/public/' }
    maven { url 'https://maven.aliyun.com/repository/google' }
    google()
}
```

---

### 构建命令

#### 1. 清理项目

```bash
./gradlew clean
```

#### 2. 构建SDK (AAR)

```bash
# Debug版本
./gradlew :duix-sdk:assembleDebug

# Release版本
./gradlew :duix-sdk:assembleRelease

# 输出路径
duix-sdk/build/outputs/aar/duix_client_sdk_release_4.1.1.aar
```

#### 3. 构建测试应用

```bash
# Debug APK
./gradlew :test:assembleDebug

# Release APK (已签名)
./gradlew :test:assembleRelease

# 输出路径
test/build/outputs/apk/release/duix_mobile_test_release_<timestamp>_4.1.1.apk
```

#### 4. 安装测试应用

```bash
# 安装Debug版本
./gradlew :test:installDebug

# 或直接安装
adb install test/build/outputs/apk/debug/test-debug.apk
```

#### 5. 代码检查

```bash
# Lint检查
./gradlew lint

# Lint报告
test/build/reports/lint-results.html
```

---

### 签名配置

#### Release签名

**文件**: `test/build.gradle`

```gradle
signingConfigs {
    release {
        storeFile file('../demo.jks')
        storePassword '123456'
        keyAlias 'demo'
        keyPassword '123456'
    }
}
```

**⚠️ 生产环境请修改为自己的签名文件！**

---

### ProGuard混淆

#### 必需的混淆规则

**文件**: `duix-sdk/proguard-rules.pro`

```proguard
# 保留JNI接口
-keep class ai.guiji.duix.DuixNcnn { *; }

# 保留公开API
-keep public class ai.guiji.duix.sdk.client.DUIX { *; }
-keep public class ai.guiji.duix.sdk.client.** { *; }

# 保留回调接口
-keep interface ai.guiji.duix.sdk.client.Callback { *; }

# 保留Native方法
-keepclasseswithmembernames class * {
    native <methods>;
}
```

---

### Native构建

#### CMake配置

**文件**: `duix-sdk/src/main/cpp/CMakeLists.txt`

```cmake
cmake_minimum_required(VERSION 3.13.2)
project(gjmywrt)

# C++标准
set(CMAKE_CXX_STANDARD 17)

# 编译选项
set(CMAKE_CXX_FLAGS "${CMAKE_CXX_FLAGS} -std=c++17 -fPIC -funwind-tables")

# 架构过滤
abiFilters 'arm64-v8a', 'armeabi-v7a'

# 链接库
target_link_libraries(gjduix
    dhcore dhmfcc dhunet
    ${OpenCV_LIBS}
    ncnn
    onnx-lib
    turbojpeg libjpeg
    -lz -lm -landroid
)
```

#### 支持的ABI

```
arm64-v8a      # 64位ARM (主流)
armeabi-v7a    # 32位ARM (兼容)
```

**注意**: 不支持x86/x86_64模拟器

---

### 持续集成 (CI/CD)

#### GitHub Actions示例

```yaml
name: Android CI

on: [push, pull_request]

jobs:
  build:
    runs-on: ubuntu-latest

    steps:
    - uses: actions/checkout@v3

    - name: Set up JDK 17
      uses: actions/setup-java@v3
      with:
        java-version: '17'
        distribution: 'temurin'

    - name: Setup Gradle
      uses: gradle/gradle-build-action@v2

    - name: Build with Gradle
      run: ./gradlew build

    - name: Run tests
      run: ./gradlew test

    - name: Upload APK
      uses: actions/upload-artifact@v3
      with:
        name: app
        path: test/build/outputs/apk/release/*.apk
```

---

### 发布流程

#### 1. 版本号管理

**文件**: `build.gradle` (根级)

```gradle
ext {
    versionCode = 13        // 每次发布递增
    versionName = "4.1.1"   // 语义化版本
}
```

#### 2. 发布检查清单

- [ ] 更新版本号
- [ ] 运行所有测试
- [ ] 执行Lint检查
- [ ] 构建Release版本
- [ ] 测试Release APK
- [ ] 生成AAR文件
- [ ] 更新CHANGELOG
- [ ] 打Git标签
- [ ] 发布到GitHub Releases

#### 3. 发布命令

```bash
# 1. 清理
./gradlew clean

# 2. 构建Release
./gradlew assembleRelease

# 3. 打标签
git tag -a v4.1.1 -m "Release version 4.1.1"
git push origin v4.1.1

# 4. 发布到GitHub Releases
# 上传文件:
# - duix-sdk/build/outputs/aar/*.aar
# - test/build/outputs/apk/release/*.apk
```

---

## 📚 附录

### 常用文件路径速查

```
SDK核心:
- DUIX主类: duix-sdk/.../DUIX.java
- 渲染线程: duix-sdk/.../thread/RenderThread.java
- 渲染器: duix-sdk/.../render/DUIXRenderer.java
- JNI接口: duix-sdk/.../DuixNcnn.java
- Native入口: duix-sdk/src/main/cpp/android/DuixJni.cpp
- DUIX核心: duix-sdk/src/main/cpp/duix/gjduix.cpp

应用入口:
- Application: test/.../App.java
- 主界面: test/.../MainActivity.kt
- 播放界面: test/.../CallActivity.kt

构建配置:
- 根构建: build.gradle
- SDK构建: duix-sdk/build.gradle
- App构建: test/build.gradle
- CMake: duix-sdk/src/main/cpp/CMakeLists.txt
```

---

### 关键API速查

#### DUIX核心API

```java
// 初始化
DUIX duix = new DUIX(context, modelUrl, renderSink, callback);
duix.init();

// 音频播放
duix.playAudio(wavPath);  // WAV文件
duix.startPush();         // PCM流开始
duix.pushPcm(pcmData);    // 推送PCM
duix.stopPush();          // PCM流结束
duix.stopAudio();         // 停止播放

// 动作控制
duix.startMotion("smile", true);  // 指定动作
duix.startRandomMotion(true);      // 随机动作

// 音量控制
duix.setVolume(0.5f);  // 0.0 ~ 1.0

// 释放资源
duix.release();
```

#### 回调事件

```java
callback.onEvent(event, msg, info);

// 事件类型
CALLBACK_EVENT_INIT_READY         // 就绪
CALLBACK_EVENT_INIT_ERROR         // 初始化错误
CALLBACK_EVENT_AUDIO_PLAY_START   // 播放开始
CALLBACK_EVENT_AUDIO_PLAY_END     // 播放结束
CALLBACK_EVENT_AUDIO_PLAY_ERROR   // 播放错误
CALLBACK_EVENT_MOTION_START       // 动作开始
CALLBACK_EVENT_MOTION_END         // 动作结束
```

#### 模型管理API

```java
// 检查模型
boolean hasBase = VirtualModelUtil.checkBaseConfig(context);
boolean hasModel = VirtualModelUtil.checkModel(context, modelUrl);

// 下载模型
VirtualModelUtil.modelDownload(context, modelUrl, new ModelDownloadCallback() {
    void onDownloadProgress(String url, long current, long total) { }
    void onUnzipProgress(String url, long current, long total) { }
    void onDownloadComplete(String url, File dir) { }
    void onDownloadFail(String url, int code, String msg) { }
});
```

---

### 常见问题排查

| 问题 | 可能原因 | 解决方案 |
|------|---------|---------|
| 初始化失败 | 模型文件不存在 | 检查 `/duix/model/` 目录，重新下载模型 |
| 渲染黑屏 | EGL配置错误 | 确保设置了 `setEGLConfigChooser(8, 8, 8, 8, 16, 0)` |
| 音频无声 | 音量设置为0 | 调用 `duix.setVolume(1.0f)` |
| 口型不动 | 音频格式错误 | 确保PCM: 16kHz, 16bit, Mono |
| 编译错误 | JDK版本不对 | 使用JDK 17 |
| NDK错误 | NDK版本不匹配 | 使用 NDK 23.1.7779620 |

---

### 性能优化建议

1. **内存优化**
   - 及时调用 `duix.release()` 释放资源
   - 使用对象池复用音频缓冲区
   - 避免在主线程执行耗时操作

2. **渲染优化**
   - 使用 `RENDERMODE_WHEN_DIRTY` 模式
   - 减少不必要的 `requestRender()` 调用
   - 优化纹理尺寸

3. **音频优化**
   - 使用流式推送而非一次性加载
   - 控制音频队列长度
   - 及时清理音频缓存

4. **模型优化**
   - 使用量化模型减小体积
   - 预加载常用模型
   - 异步加载模型文件

---

### 联系与支持

- **GitHub**: [duixcom/Duix-Mobile](https://github.com/duixcom/Duix-Mobile)
- **问题反馈**: GitHub Issues
- **文档**: README.md

---

## 📝 更新日志

| 日期 | 版本 | 更新内容 |
|------|------|---------|
| 2025-10-02 | 1.1.0 | 架构重构：本地/云端数字人模块分离，添加返回按钮模块化设计 |
| 2025-10-02 | 1.0.0 | 初始版本，完整项目说明文档 |

---

**文档结束**

本文档由 Claude AI 基于项目代码自动生成。
项目遵循严格的代码规范和架构设计原则。
