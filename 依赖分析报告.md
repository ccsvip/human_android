# human_android 项目全面依赖分析报告

生成日期：2025-10-02 (更新版)
项目类型：Android 2D虚拟数字人SDK
更新内容：架构重构 - 本地/云端数字人模块分离

---

## 一、项目概览

### 1.1 项目结构
```
human_android/
├── duix-sdk/          # 核心SDK模块
│   ├── src/main/
│   │   ├── java/      # Java/Kotlin代码
│   │   ├── cpp/       # Native C++代码
│   │   └── libs/      # 预编译JAR库
│   └── build.gradle
├── test/              # 示例应用模块
│   ├── src/main/
│   │   └── java/      # Kotlin代码
│   └── build.gradle
└── build.gradle       # 根项目配置
```

### 1.2 编译配置
- **Gradle版本**: 8.1.2
- **Kotlin版本**: 1.8.10
- **编译SDK**: 33/34
- **最低SDK**: 24 (Android 7.0)
- **NDK版本**: 23.1.7779620
- **CMake版本**: 4.1.0
- **支持架构**: arm64-v8a, armeabi-v7a

---

## 二、模块依赖关系树

### 2.1 Test模块完整依赖树

```
test (示例应用)
├── 直接依赖
│   ├── project(":duix-sdk") ⭐ 核心SDK依赖
│   ├── androidx.core:core-ktx:1.12.0
│   ├── androidx.appcompat:appcompat:1.2.0
│   ├── com.google.android.material:material:1.4.0
│   ├── androidx.constraintlayout:constraintlayout:2.1.1
│   ├── androidx.activity:activity:1.3.0
│   ├── androidx.fragment:fragment:1.3.0
│   ├── com.github.bumptech.glide:glide:4.12.0 (图片加载)
│   └── com.squareup.okhttp3:okhttp:4.10.0 (网络请求)
│
├── 核心入口类
│   ├── App.java (Application)
│   │   └── 依赖: OkHttpClient (网络客户端初始化)
│   │
│   ├── MainActivity.kt (主界面路由)
│   │   ├── import ai.guiji.duix.sdk.client.BuildConfig
│   │   ├── import ai.guiji.duix.sdk.welcome.WelcomeActivity (欢迎页面)
│   │   ├── import ai.guiji.duix.sdk.welcome.WelcomeConfig (欢迎配置)
│   │   ├── Intent, Bundle (Android框架)
│   │   └── 根据用户选择路由到本地/云端数字人界面
│   │
│   ├── local/LocalMainActivity.kt (本地数字人配置界面)
│   │   ├── import ai.guiji.duix.sdk.client.BuildConfig
│   │   ├── import ai.guiji.duix.sdk.client.VirtualModelUtil (模型管理)
│   │   ├── ActivityLocalMainBinding (ViewBinding)
│   │   ├── LoadingDialog (自定义对话框)
│   │   ├── ModelSelectorDialog (模型选择对话框)
│   │   └── Toast (Android UI组件)
│   │
│   ├── local/LocalCallActivity.kt (本地数字人播放界面) ⭐ 核心界面
│   │   ├── import ai.guiji.duix.sdk.client.Constant (常量定义)
│   │   ├── import ai.guiji.duix.sdk.client.DUIX ⭐ (核心SDK接口)
│   │   ├── import ai.guiji.duix.sdk.client.loader.ModelInfo (模型信息，在JAR中)
│   │   ├── import ai.guiji.duix.sdk.client.render.DUIXRenderer (渲染器)
│   │   ├── import ai.guiji.duix.sdk.client.thread.RenderThread (渲染线程)
│   │   ├── ActivityLocalCallBinding (ViewBinding)
│   │   ├── MotionAdapter (动作列表适配器)
│   │   ├── AudioRecordDialog (录音对话框)
│   │   ├── StringUtils (工具类)
│   │   ├── GLSurfaceView (OpenGL渲染视图)
│   │   ├── Glide (图片加载库)
│   │   └── FileInputStream, FileOutputStream (文件IO)
│   │
│   ├── cloud/CloudMainActivity.kt (云端数字人占位界面)
│   │   ├── ActivityCloudMainBinding (ViewBinding)
│   │   └── 显示"云端数字人尚未开发"提示
│   │
│   └── BaseActivity.java (基础Activity)
│       ├── 提供权限管理、上下文等基础功能
│       └── backToMainMenu() 返回主界面方法
│
├── UI组件
│   ├── ui/adapter/
│   │   ├── ModelSelectorAdapter.kt (模型选择适配器)
│   │   └── MotionAdapter.kt (动作列表适配器)
│   │
│   └── ui/dialog/
│       ├── LoadingDialog.kt (加载对话框)
│       ├── AudioRecordDialog.kt (录音对话框)
│       └── ModelSelectorDialog.kt (模型选择对话框)
│
├── 工具类
│   ├── audio/AudioRecorder.java (音频录制)
│   ├── render/DebugSink.java (调试渲染接收器)
│   ├── net/SyncDownloadFile.java (同步下载)
│   ├── service/StorageService.java (存储服务)
│   └── util/
│       ├── SystemUtils.java (系统工具)
│       ├── ZipUtil.java (ZIP工具)
│       └── StringUtils.java (字符串工具)
│
└── 权限依赖
    ├── android.permission.INTERNET (网络访问)
    └── android.permission.RECORD_AUDIO (音频录制)
```

### 2.2 DUIX-SDK模块完整依赖树

```
duix-sdk (核心SDK)
├── 直接依赖
│   ├── androidx.appcompat:appcompat:1.6.1
│   ├── androidx.activity:activity-ktx:1.7.2
│   └── fileTree(libs/) ⭐ resource_loader.jar
│       └── 包含: ModelInfo, ModelInfoLoader, VersionInfo (模型加载相关类)
│
├── Native库依赖
│   └── System.loadLibrary("gjduix") ⭐ 核心Native库
│
├── 核心类层次
│   ├── DUIX.java ⭐⭐⭐ (SDK主入口类)
│   │   ├── 依赖关系:
│   │   │   ├── Context (Android上下文)
│   │   │   ├── File, FileInputStream (文件操作)
│   │   │   ├── ExecutorService, Executors (线程池)
│   │   │   ├── ModelInfo (模型信息，来自resource_loader.jar)
│   │   │   ├── RenderSink (渲染接收器接口)
│   │   │   └── RenderThread ⭐ (渲染线程)
│   │   │
│   │   ├── 初始化流程依赖:
│   │   │   ├── 检查模型目录: /duix/model/gj_dh_res (基础配置)
│   │   │   ├── 检查模型目录: /duix/model/{modelName} (模型文件)
│   │   │   └── 创建RenderThread进行实际渲染
│   │   │
│   │   └── 核心功能:
│   │       ├── init() - 模型加载和初始化
│   │       ├── startPush/pushPcm/stopPush() - PCM音频流推送
│   │       ├── playAudio() - WAV文件播放
│   │       ├── stopAudio() - 停止音频
│   │       ├── startMotion() - 指定动作播放
│   │       ├── startRandomMotion() - 随机动作播放
│   │       ├── setVolume() - 音量控制
│   │       └── release() - 资源释放
│   │
│   ├── RenderThread.java ⭐⭐⭐ (渲染核心线程)
│   │   ├── 依赖关系:
│   │   │   ├── Context (Android上下文)
│   │   │   ├── Handler, Looper, Message (消息机制)
│   │   │   ├── File (文件操作)
│   │   │   ├── ByteBuffer (字节缓冲区)
│   │   │   ├── ConcurrentLinkedQueue (线程安全队列)
│   │   │   ├── DuixNcnn ⭐ (JNI Native接口)
│   │   │   ├── AudioPlayer (音频播放器)
│   │   │   ├── ImageFrame (图像帧数据结构)
│   │   │   ├── ModelInfo, ModelInfoLoader (模型信息加载，来自JAR)
│   │   │   ├── RenderSink (渲染输出接口)
│   │   │   └── Logger (日志工具)
│   │   │
│   │   ├── Native调用链:
│   │   │   ├── scrfdncnn.alloc() - 分配Native资源
│   │   │   ├── scrfdncnn.initPcmex() - 初始化PCM处理
│   │   │   ├── scrfdncnn.initMunetex()/initMunet() - 初始化UNet模型
│   │   │   ├── scrfdncnn.initWenet() - 初始化Wenet模型
│   │   │   ├── scrfdncnn.newsession() - 创建音频会话
│   │   │   ├── scrfdncnn.pushpcm() - 推送PCM数据
│   │   │   ├── scrfdncnn.finsession() - 结束会话
│   │   │   ├── scrfdncnn.readycnt() - 获取准备就绪的BNF数量
│   │   │   ├── scrfdncnn.filerst() - 渲染帧(带口型驱动)
│   │   │   ├── scrfdncnn.fileload() - 加载帧(不带口型驱动)
│   │   │   └── scrfdncnn.free() - 释放Native资源
│   │   │
│   │   ├── 渲染循环 (40ms/帧，25fps):
│   │   │   ├── 检查动作队列 → 准备帧序列
│   │   │   ├── 检查口型驱动 → 调用filerst或fileload
│   │   │   ├── 渲染结果输出 → onVideoFrame()
│   │   │   └── 性能统计 → Reporter.onRenderStat()
│   │   │
│   │   └── 消息处理:
│   │       ├── MSG_RENDER_STEP - 渲染步进
│   │       ├── MSG_START_PUSH_AUDIO - 开始音频推送
│   │       ├── MSG_PUSH_AUDIO - 推送音频数据
│   │       ├── MSG_STOP_PUSH_AUDIO - 停止音频推送
│   │       ├── MSG_STOP_PLAY_AUDIO - 停止音频播放
│   │       ├── MSG_REQUIRE_MOTION - 请求指定动作
│   │       ├── MSG_REQUIRE_MOTION_RANDOM - 请求随机动作
│   │       └── MSG_STOP_RENDER/MSG_QUIT - 停止和退出
│   │
│   ├── DuixNcnn.java ⭐⭐ (JNI接口类)
│   │   ├── Native方法声明:
│   │   │   ├── alloc() - 分配内存
│   │   │   ├── free() - 释放内存
│   │   │   ├── initPcmex() - 初始化PCM扩展
│   │   │   ├── initWenet() - 初始化Wenet模型
│   │   │   ├── initMunet()/initMunetex() - 初始化UNet模型
│   │   │   ├── newsession() - 创建新会话
│   │   │   ├── finsession() - 结束会话
│   │   │   ├── consession() - 连接会话
│   │   │   ├── allcnt() - 获取全部计数
│   │   │   ├── readycnt() - 获取就绪计数
│   │   │   ├── pushpcm() - 推送PCM数据
│   │   │   ├── filerst() - 文件渲染(带BNF)
│   │   │   ├── bufrst() - 缓冲区渲染
│   │   │   ├── fileload() - 文件加载
│   │   │   ├── startgpg()/stopgpg() - GPG加密
│   │   │   └── processmd5() - MD5处理
│   │   │
│   │   └── static { System.loadLibrary("gjduix"); }
│   │
│   ├── VirtualModelUtil.java (模型管理工具)
│   │   ├── 依赖关系:
│   │   │   ├── Context (Android上下文)
│   │   │   ├── File (文件操作)
│   │   │   └── DownloadZipService (下载解压服务)
│   │   │
│   │   └── 核心功能:
│   │       ├── checkBaseConfig() - 检查基础配置存在性
│   │       ├── checkModel() - 检查模型存在性
│   │       ├── baseConfigDownload() - 下载基础配置
│   │       └── modelDownload() - 下载模型文件
│   │
│   ├── 渲染模块 (render/)
│   │   ├── DUIXRenderer.java ⭐ (默认渲染器)
│   │   │   ├── 依赖: Context, OpenGL ES 2.0
│   │   │   ├── 实现: DUIXTextureView.Renderer, RenderSink
│   │   │   ├── 包含: ImageDrawer (图像绘制器)
│   │   │   ├── 使用: OpenGLUtil (MVP矩阵计算)
│   │   │   └── 处理: 图像缩放(CROP/INSIDE)、透明混合
│   │   │
│   │   ├── DUIXTextureView.java (OpenGL渲染视图)
│   │   │   ├── 继承: GLSurfaceView
│   │   │   ├── EGL配置: RGBA_8888 + Alpha通道
│   │   │   └── 渲染模式: RENDERMODE_WHEN_DIRTY
│   │   │
│   │   ├── RenderSink.java (渲染输出接口)
│   │   │   └── onVideoFrame(ImageFrame) - 接收渲染帧
│   │   │
│   │   ├── ImageDrawer.java (图像绘制器)
│   │   │   ├── 使用: OpenGL ES着色器
│   │   │   ├── 处理: 纹理绘制、MVP矩阵变换
│   │   │   └── 支持: RGB和RGBA格式
│   │   │
│   │   └── TextureMatrix.java (纹理矩阵工具)
│   │       └── 矩阵变换计算
│   │
│   ├── 音频模块 (audio/)
│   │   └── AudioPlayer.java (音频播放器)
│   │       ├── 依赖: AudioTrack (Android音频API)
│   │       ├── 配置: 16kHz, 单声道, PCM_16BIT
│   │       ├── 缓冲区: 1280字节 (10ms)
│   │       ├── 使用: ConcurrentLinkedQueue (线程安全队列)
│   │       └── 功能:
│   │           ├── pushStart/pushData/pushDone() - 数据推送
│   │           ├── startPlay() - 开始播放
│   │           ├── stop() - 停止播放
│   │           ├── setVolume() - 音量控制
│   │           └── getPlayIndex() - 获取播放位置(40ms索引)
│   │
│   ├── 网络模块 (net/)
│   │   ├── DownloadZipService.java (下载解压服务)
│   │   │   ├── 依赖: FileDownloader, ZipUtil, MD5Util
│   │   │   ├── 使用: ExecutorService (单线程池)
│   │   │   └── 功能: 下载ZIP → 解压 → 清理缓存
│   │   │
│   │   └── FileDownloader.java (文件下载器)
│   │       ├── 实现: HTTP下载、断点续传
│   │       └── 回调: 下载进度
│   │
│   ├── 数据模型 (bean/)
│   │   ├── ImageFrame.java (图像帧)
│   │   │   ├── rawBuffer: ByteBuffer (RGB数据)
│   │   │   ├── maskBuffer: ByteBuffer (Mask数据)
│   │   │   └── width, height: int (尺寸)
│   │   │
│   │   └── AudioFrame.java (音频帧)
│   │       ├── buffer: byte[] (PCM数据)
│   │       ├── size: int (数据大小)
│   │       └── completeEmptyFrame: boolean (结束标志)
│   │
│   ├── 工具类 (util/)
│   │   ├── Logger.java (日志工具)
│   │   ├── FileUtil.java (文件工具)
│   │   ├── MD5Util.java (MD5工具)
│   │   ├── OpenGLUtil.java (OpenGL工具)
│   │   ├── ZipUtil.java (ZIP工具)
│   │   ├── DeviceUtils.java (设备工具)
│   │   └── SystemUtils.java (系统工具)
│   │
│   ├── 欢迎页面模块 (welcome/) ⭐ 新增功能
│   │   ├── WelcomeActivity.kt (欢迎页面Activity)
│   │   │   ├── 依赖: WebView, JavaScript接口
│   │   │   ├── 加载: assets/welcome/welcome.html
│   │   │   ├── 功能: 全屏显示、用户选择处理
│   │   │   └── 结果码:
│   │   │       ├── RESULT_LOCAL_CHOICE (100) - 本地模式
│   │   │       └── RESULT_CLOUD_CHOICE (101) - 云端模式
│   │   │
│   │   └── WelcomeConfig.kt (欢迎配置管理)
│   │       ├── 使用: SharedPreferences
│   │       ├── 配置项:
│   │       │   ├── KEY_FIRST_LAUNCH - 首次启动标志
│   │       │   ├── KEY_USER_CHOICE - 用户选择
│   │       │   ├── KEY_CHOICE_TIMESTAMP - 选择时间戳
│   │       │   └── KEY_WELCOME_VERSION - 欢迎页面版本
│   │       │
│   │       └── 功能:
│   │           ├── shouldShowWelcomePage() - 判断是否显示
│   │           ├── saveUserChoice() - 保存用户选择
│   │           ├── getUserChoice() - 获取用户选择
│   │           └── resetWelcomeConfig() - 重置配置
│   │
│   └── 常量和回调
│       ├── Constant.java (常量定义)
│       │   ├── CALLBACK_EVENT_INIT_READY - 初始化完成
│       │   ├── CALLBACK_EVENT_INIT_ERROR - 初始化错误
│       │   ├── CALLBACK_EVENT_AUDIO_PLAY_START - 音频开始
│       │   ├── CALLBACK_EVENT_AUDIO_PLAY_END - 音频结束
│       │   ├── CALLBACK_EVENT_AUDIO_PLAY_ERROR - 音频错误
│       │   ├── CALLBACK_EVENT_MOTION_START - 动作开始
│       │   └── CALLBACK_EVENT_MOTION_END - 动作结束
│       │
│       └── Callback.java (回调接口)
│           └── onEvent(event, msg, info)
```

---

## 三、Native代码依赖关系

### 3.1 C++模块结构

```
Native代码 (duix-sdk/src/main/cpp)
├── CMakeLists.txt (构建配置)
│   ├── 编译目标: libgjduix.so
│   ├── C++标准: C++17
│   ├── 编译标志: -fPIC, -funwind-tables, -fno-omit-frame-pointer
│   └── 支持架构: arm64-v8a, armeabi-v7a
│
├── JNI接口层 (android/)
│   ├── DuixJni.cpp ⭐⭐ (JNI实现)
│   │   ├── 包含头文件:
│   │   │   ├── <jni.h> (JNI标准接口)
│   │   │   ├── <android/log.h> (Android日志)
│   │   │   ├── <android/asset_manager_jni.h> (资源管理)
│   │   │   ├── <android/native_window_jni.h> (窗口管理)
│   │   │   ├── "gjsimp.h" (数字人核心接口)
│   │   │   ├── "JniHelper.h" (JNI辅助工具)
│   │   │   ├── "aesmain.h" (AES加密)
│   │   │   ├── "jmat.h" (矩阵运算)
│   │   │   └── "Log.h" (日志工具)
│   │   │
│   │   ├── 全局变量:
│   │   │   ├── dhduix_t* g_digit (数字人实例)
│   │   │   ├── JMat* g_gpgmat (GPG矩阵)
│   │   │   ├── int g_width, g_height (图像尺寸)
│   │   │   └── int g_taskid (任务ID)
│   │   │
│   │   └── JNI函数实现:
│   │       ├── JNI_OnLoad/OnUnload (生命周期)
│   │       ├── Java_ai_guiji_duix_DuixNcnn_* (所有Native方法)
│   │       └── 字符串转换工具 getStringUTF()
│   │
│   ├── JniHelper.cpp (JNI辅助工具)
│   │   └── sJavaVM (全局JavaVM引用)
│   │
│   └── Log.cpp (Android日志封装)
│       └── __android_log_print 封装
│
├── 核心算法层 (duix/)
│   ├── gjsimp.cpp ⭐⭐⭐ (数字人简化实现)
│   │   ├── 包含头文件:
│   │   │   ├── "gjsimp.h"
│   │   │   ├── "dhwenet.h" (Wenet语音处理)
│   │   │   ├── "wenetai.h" (Wenet AI接口)
│   │   │   ├── "dhpcm.h" (PCM音频处理)
│   │   │   ├── "munet.h" (UNet模型)
│   │   │   ├── "malpha.h" (Alpha通道处理)
│   │   │   └── <queue> (STL队列)
│   │   │
│   │   ├── dhduix_s结构体 (数字人状态):
│   │   │   ├── 模型相关: kind, rect, width, height
│   │   │   ├── 音频处理: mincalc, minoff, minblock, maxblock
│   │   │   ├── Wenet模型: weai_first, weai_common, wenetfn
│   │   │   ├── 会话管理: cursess, sessid, slist
│   │   │   ├── UNet模型: munet, rgb
│   │   │   ├── 矩阵对象: mat_feat, mat_pic, mat_fg, mat_msk
│   │   │   └── 线程同步: calcthread, pushmutex, readmutex, freemutex
│   │   │
│   │   ├── 核心函数:
│   │   │   ├── dhduix_alloc() - 分配数字人实例
│   │   │   ├── dhduix_initPcmex() - 初始化PCM处理
│   │   │   ├── dhduix_initWenet() - 初始化Wenet模型
│   │   │   ├── dhduix_initMunet(ex)() - 初始化UNet模型
│   │   │   ├── dhduix_newsession() - 创建音频会话
│   │   │   ├── dhduix_pushpcm() - 推送PCM数据
│   │   │   ├── dhduix_finsession() - 结束会话
│   │   │   ├── dhduix_fileinx() - 文件索引渲染
│   │   │   ├── dhduix_simpinx() - 简单索引渲染
│   │   │   └── dhduix_free() - 释放数字人实例
│   │   │
│   │   └── calcworker线程 (音频特征计算线程)
│   │       └── 循环调用 PcmSession->runcalc()
│   │
│   └── gjduix.cpp (数字人完整实现)
│       ├── dhmfcc_s结构体 (MFCC处理)
│       └── MFCC相关函数实现
│
├── 音频处理层 (dhmfcc/)
│   ├── dhpcm.cpp (PCM音频处理)
│   │   └── PCM流管理、会话管理
│   │
│   ├── dhwenet.cpp (Wenet集成)
│   │   └── Wenet模型封装
│   │
│   ├── wenetai.cpp (Wenet AI接口)
│   │   └── WeAI接口实现
│   │
│   ├── mfcc.cpp (MFCC特征提取)
│   │   └── 音频特征计算
│   │
│   ├── iir_filter.cpp (IIR滤波器)
│   │   └── 音频滤波处理
│   │
│   └── AudioFFT.cpp (FFT变换)
│       └── 快速傅里叶变换
│
├── 图像处理层 (dhunet/)
│   ├── munet.cpp (UNet模型)
│   │   └── 人脸驱动神经网络
│   │
│   ├── malpha.cpp (Alpha通道处理)
│   │   └── 透明度处理
│   │
│   ├── blendgram.cpp (图像融合)
│   │   └── 帧融合算法
│   │
│   ├── face_utils.cpp (人脸工具)
│   │   └── 人脸区域处理
│   │
│   └── jmat.cpp (矩阵运算)
│       ├── JMat类实现
│       ├── JPEG加载/保存
│       └── 图像格式转换
│
├── 核心数据结构层 (dhcore/)
│   ├── dh_data.cpp (数据结构)
│   │   └── 基础数据类型封装
│   │
│   ├── dh_que.cpp (队列实现)
│   │   └── 线程安全队列
│   │
│   ├── dh_mem.c (内存管理)
│   │   └── 内存分配/释放
│   │
│   └── 头文件:
│       ├── concurrentqueue.h (并发队列)
│       ├── blockingconcurrentqueue.h (阻塞并发队列)
│       ├── readerwriterqueue.h (读写队列)
│       ├── lightweightsemaphore.h (轻量级信号量)
│       └── dh_atomic.h (原子操作)
│
├── 加密层 (aes/)
│   ├── aes_cbc.c, aes_core.c, aes_ecb.c (AES加密)
│   ├── gj_aes.c (国机AES封装)
│   ├── base64.c (Base64编解码)
│   ├── cbc128.c (CBC模式)
│   └── aesmain.c (加密主程序)
│
└── 测试代码 (iostest/)
    ├── testduix.cpp (数字人测试)
    └── testsimp.cpp (简化接口测试)
```

### 3.2 Native依赖库映射

```
Native库调用关系:
├── libgjduix.so (最终生成库)
│   ├── 依赖静态库:
│   │   ├── libdhcore.a (核心数据结构)
│   │   ├── libdhmfcc.a (MFCC音频处理)
│   │   └── libdhunet.a (UNet图像处理)
│   │
│   └── 依赖第三方库:
│       ├── OpenCV (图像处理)
│       │   ├── libopencv_core.a
│       │   ├── libopencv_imgproc.a
│       │   ├── libopencv_highgui.a
│       │   ├── libopencv_photo.a
│       │   ├── libopencv_video.a
│       │   └── libopencv_features2d.a
│       │
│       ├── NCNN (神经网络推理)
│       │   └── libncnn.so (动态库)
│       │
│       ├── ONNX Runtime (AI模型运行时)
│       │   └── libonnxruntime.so (动态库)
│       │
│       ├── JPEG处理
│       │   ├── libjpeg.a
│       │   └── libturbojpeg.a (高性能JPEG)
│       │
│       ├── FFmpeg (音视频处理)
│       │   ├── libavcodec.a
│       │   ├── libavdevice.a
│       │   ├── libavfilter.a
│       │   ├── libavformat.a
│       │   ├── libavutil.a
│       │   ├── libswresample.a
│       │   └── libswscale.a
│       │
│       ├── OpenSSL (加密)
│       │   ├── libssl.a
│       │   └── libcrypto.a
│       │
│       ├── CURL (网络请求)
│       │   └── libcurl.a
│       │
│       ├── PPL (并行计算)
│       │   ├── libpplcommon_static.a
│       │   └── libpplcv_static.a
│       │
│       └── Android系统库
│           ├── -lm (数学库)
│           ├── -lz (压缩库)
│           ├── -pthread (线程库)
│           └── -landroid (Android Native API)
```

---

## 四、第三方库详细清单

### 4.1 Android依赖库

| 库名称 | 版本 | 用途 | 模块 |
|--------|------|------|------|
| androidx.core:core-ktx | 1.12.0 | Kotlin扩展 | test |
| androidx.appcompat:appcompat | 1.2.0/1.6.1 | 兼容性支持 | test, duix-sdk |
| androidx.activity:activity | 1.3.0 | Activity支持 | test |
| androidx.activity:activity-ktx | 1.7.2 | Activity Kotlin扩展 | duix-sdk |
| androidx.fragment:fragment | 1.3.0 | Fragment支持 | test |
| com.google.android.material:material | 1.4.0 | Material Design | test |
| androidx.constraintlayout:constraintlayout | 2.1.1 | 约束布局 | test |
| com.github.bumptech.glide:glide | 4.12.0 | 图片加载 | test |
| com.squareup.okhttp3:okhttp | 4.10.0 | HTTP客户端 | test |

### 4.2 Native第三方库

| 库名称 | 版本 | 类型 | 架构支持 | 用途 |
|--------|------|------|----------|------|
| **NCNN** | 20231027 | .so | arm64-v8a, armeabi-v7a | 神经网络推理框架 |
| **OpenCV Mobile** | 4.6.0 | .a | arm64-v8a, armeabi-v7a | 计算机视觉库 |
| **ONNX Runtime** | - | .so | arm64-v8a, armeabi-v7a | AI模型运行时 |
| **TurboJPEG** | - | .a | arm64-v8a, armeabi-v7a | 高性能JPEG编解码 |
| **FFmpeg Lite** | - | .a | arm64-v8a, armeabi-v7a | 音视频处理 |
| **OpenSSL** | - | .a | arm64-v8a, armeabi-v7a | 加密库 |
| **CURL** | - | .a | arm64-v8a, armeabi-v7a | 网络传输 |
| **PPL** | - | .a | arm64-v8a, armeabi-v7a | 并行计算库 |

### 4.3 核心库功能说明

#### NCNN (Neural Computing Neural Network)
- **版本**: 2023-10-27
- **作用**: 轻量级神经网络推理框架
- **在项目中的应用**:
  - UNet人脸驱动模型推理
  - Wenet语音特征提取模型推理
  - 口型驱动的BNF特征生成
- **调用路径**: RenderThread → DuixNcnn → gjsimp → NCNN C++ API

#### OpenCV Mobile 4.6.0
- **作用**: 移动端优化的计算机视觉库
- **在项目中的应用**:
  - 图像加载和格式转换
  - 图像缩放和裁剪
  - 颜色空间转换(RGB/BGR)
  - 矩阵运算
- **使用的模块**:
  - core: 核心数据结构
  - imgproc: 图像处理
  - highgui: 高层GUI和媒体I/O
  - photo: 计算摄影
  - video: 视频分析

#### ONNX Runtime
- **作用**: 跨平台AI模型推理引擎
- **在项目中的应用**:
  - Wenet语音识别模型运行
  - 支持.onnx格式模型加载
  - 优化的推理性能
- **调用路径**: dhwenet → wenetai → ONNX Runtime C++ API

#### TurboJPEG
- **作用**: 高性能JPEG图像编解码库
- **在项目中的应用**:
  - 数字人帧图像的JPEG解码
  - Mask图像的JPEG解码
  - 性能优化的批量图像加载
- **调用路径**: JMat::loadjpg() → TurboJPEG API

---

## 五、关键依赖链路分析

### 5.1 应用启动依赖链

```
应用启动流程:
App.onCreate()
  └── 初始化OkHttpClient (网络客户端)
      └── 设置超时: 15秒

MainActivity.onCreate()
  ├── 检查欢迎页面状态
  │   ├── WelcomeConfig.shouldShowWelcomePage()
  │   │   ├── 检查首次启动标志
  │   │   ├── 检查版本更新
  │   │   └── 检查用户选择状态
  │   │
  │   └── [如果需要] 启动WelcomeActivity
  │       ├── 加载 assets/welcome/welcome.html
  │       ├── 注册 JavaScript 接口
  │       ├── 用户选择 (本地/云端)
  │       └── 保存选择 → WelcomeConfig
  │
  ├── 初始化UI
  │   ├── ActivityMainBinding (ViewBinding)
  │   ├── 模型选择对话框
  │   └── 调试开关
  │
  └── 准备播放
      ├── VirtualModelUtil.checkBaseConfig()
      │   └── 检查 /duix/model/gj_dh_res/
      │
      ├── [如不存在] VirtualModelUtil.baseConfigDownload()
      │   └── DownloadZipService.downloadAndUnzip()
      │       ├── FileDownloader.download() (ZIP文件)
      │       ├── ZipUtil.unzip() (解压到目标目录)
      │       └── 创建标记文件 /tmp/gj_dh_res
      │
      ├── VirtualModelUtil.checkModel(modelUrl)
      │   └── 检查 /duix/model/{modelName}/
      │
      ├── [如不存在] VirtualModelUtil.modelDownload()
      │   └── 下载解压流程同上
      │
      └── 跳转到CallActivity
```

### 5.2 数字人初始化依赖链

```
数字人初始化流程:
CallActivity.onCreate()
  ├── 初始化UI
  │   ├── GLSurfaceView配置
  │   │   ├── EGL版本: 2
  │   │   ├── EGL配置: RGBA_8888 (支持透明)
  │   │   └── 渲染模式: RENDERMODE_WHEN_DIRTY
  │   │
  │   └── 背景加载 (Glide)
  │
  ├── 创建DUIXRenderer
  │   ├── new DUIXRenderer(context, glTextureView)
  │   │   └── 实现 RenderSink 接口
  │   │
  │   └── glTextureView.setRenderer(renderer)
  │
  ├── 创建DUIX实例
  │   └── new DUIX(context, modelUrl, renderer, callback)
  │       ├── 保存参数
  │       ├── 创建线程池 (单线程)
  │       └── 等待init()调用
  │
  └── 开始初始化
      └── duix.init()
          ├── 检查模型目录
          │   ├── /duix/model/gj_dh_res/ (基础配置)
          │   └── /duix/model/{modelName}/ (模型文件)
          │
          ├── 创建RenderThread
          │   └── new RenderThread(context, modelDir, renderSink, volume, callback, reporter)
          │       ├── 保存参数
          │       └── start() 启动线程
          │
          └── RenderThread.run()
              ├── 初始化Looper和Handler
              ├── 创建AudioPlayer
              ├── 创建DuixNcnn实例
              │   └── System.loadLibrary("gjduix") ⭐ 加载Native库
              │
              ├── ModelInfoLoader.load() ⭐ 加载模型配置
              │   ├── 读取 model.json (模型元数据)
              │   ├── 读取 action.json (动作区间)
              │   └── 创建ModelInfo对象
              │
              ├── Native初始化 (JNI调用链)
              │   ├── scrfdncnn.alloc(taskid, mincalc, width, height)
              │   │   └── [C++] dhduix_alloc()
              │   │       ├── 分配dhduix_t结构体
              │   │       ├── 初始化互斥锁
              │   │       ├── 创建calcworker线程 (音频特征计算)
              │   │       ├── 分配JMat矩阵对象
              │   │       └── 分配jmat特征矩阵
              │   │
              │   ├── scrfdncnn.initPcmex(maxsize, minoff, minblock, maxblock, rgb)
              │   │   └── [C++] dhduix_initPcmex()
              │   │       └── 配置PCM音频处理参数
              │   │
              │   ├── scrfdncnn.initMunetex(unetparam, unetbin, unetmsk, kind)
              │   │   └── [C++] dhduix_initMunetex()
              │   │       └── [C++] munet初始化
              │   │           ├── 加载NCNN模型文件
              │   │           │   ├── *.param (模型结构)
              │   │           │   └── *.bin (模型权重)
              │   │           ├── 加载Mask文件
              │   │           └── 配置人脸驱动区域 (kind=168)
              │   │
              │   └── scrfdncnn.initWenet(wenetfn)
              │       └── [C++] dhduix_initWenet()
              │           └── [C++] WeAI初始化
              │               ├── 加载ONNX模型文件 (*.onnx)
              │               ├── 创建ONNX Runtime会话
              │               ├── 配置MFCC参数
              │               │   ├── mel频率数量
              │               │   └── BNF特征数量
              │               └── 执行测试推理
              │
              ├── 分配渲染缓冲区
              │   ├── rawBuffer: width * height * 3 (RGB数据)
              │   └── maskBuffer: width * height * 3 (Mask数据)
              │
              ├── 回调初始化完成
              │   └── callback.onInitResult(0, 0, modelInfo.toString(), modelInfo)
              │       └── [Java] DUIX.Callback.onEvent(CALLBACK_EVENT_INIT_READY)
              │           └── [UI] CallActivity显示控制按钮
              │
              └── 启动渲染循环
                  └── handleAudioStep() (每40ms一次)
```

### 5.3 音频驱动渲染依赖链

```
音频驱动口型流程:
用户点击"播放PCM"或"播放WAV"
  │
  ├── PCM流式播放流程:
  │   └── duix.startPush()
  │       └── RenderThread.startPush()
  │           └── Handler发送MSG_START_PUSH_AUDIO
  │               └── handleStartPushAudio()
  │                   ├── scrfdncnn.newsession() ⭐ 创建新音频会话
  │                   │   └── [C++] dhduix_newsession()
  │                   │       ├── 创建PcmSession对象
  │                   │       ├── 分配会话ID (sessid)
  │                   │       ├── 初始化PCM缓冲区
  │                   │       └── 启动calcworker线程处理
  │                   │
  │                   └── audioPlayer.pushStart() (准备播放)
  │                       └── 清空播放队列
  │
  │   [循环] 用户推送PCM数据
  │   └── duix.pushPcm(data)
  │       └── RenderThread.pushAudio(data)
  │           └── Handler发送MSG_PUSH_AUDIO
  │               └── handlePushAudio(data)
  │                   ├── scrfdncnn.pushpcm(sessid, data, size, kind) ⭐
  │                   │   └── [C++] dhduix_pushpcm()
  │                   │       ├── 写入PCM数据到会话缓冲区
  │                   │       ├── [calcworker线程] 触发音频特征计算
  │                   │       │   └── PcmSession.runcalc()
  │                   │       │       ├── 累积PCM数据到minblock大小
  │                   │       │       ├── 提取MFCC特征
  │                   │       │       ├── [ONNX] Wenet模型推理
  │                   │       │       │   ├── 输入: MFCC特征
  │                   │       │       │   └── 输出: BNF特征 (20维)
  │                   │       │       └── BNF特征入队 (准备渲染)
  │                   │       └── 返回推送成功
  │                   │
  │                   └── audioPlayer.pushData(data) (推送播放数据)
  │                       ├── 分帧: 每1280字节 (10ms)
  │                       └── AudioFrame入队
  │
  │   [结束] 用户停止推送
  │   └── duix.stopPush()
  │       └── RenderThread.stopPush()
  │           └── Handler发送MSG_STOP_PUSH_AUDIO
  │               └── handleStopPushAudio()
  │                   ├── scrfdncnn.finsession(sessid) ⭐ 结束会话
  │                   │   └── [C++] dhduix_finsession()
  │                   │       ├── 标记会话结束
  │                   │       ├── 处理剩余PCM数据
  │                   │       └── 生成最后的BNF特征
  │                   │
  │                   └── audioPlayer.pushDone() (标记播放结束)
  │                       └── 推送空帧标记 (completeEmptyFrame=true)
  │
  └── WAV文件播放流程:
      └── duix.playAudio(wavPath)
          ├── 读取WAV文件
          ├── 跳过44字节头部
          ├── 提取PCM数据
          └── 调用startPush/pushPcm/stopPush流程

渲染循环 (MSG_RENDER_STEP, 每40ms):
└── renderStep()
    ├── 检查BNF特征就绪
    │   └── scrfdncnn.readycnt(sessid)
    │       └── [C++] dhduix_readycnt()
    │           └── 返回已计算的BNF特征数量
    │
    ├── [如果BNF就绪] 口型驱动渲染
    │   ├── audioPlayer未启动 → 启动播放
    │   │   └── audioPlayer.startPlay()
    │   │       ├── audioTrack.play() (开始AudioTrack播放)
    │   │       └── PlaybackThread启动 (从队列取AudioFrame播放)
    │   │
    │   ├── 获取当前播放位置
    │   │   └── bnfIndex = audioPlayer.getPlayIndex()
    │   │       └── (播放位置毫秒数 / 40) = 帧索引
    │   │
    │   └── 渲染带口型的帧
    │       └── scrfdncnn.filerst(sessid, picPath, mskPath, box, "", bnfIndex, rawBuffer, maskBuffer, imgsize) ⭐⭐
    │           └── [C++] dhduix_fileinx()
    │               ├── 加载原始帧图像 (picPath)
    │               │   └── [TurboJPEG] JPEG解码 → RGB
    │               │
    │               ├── 加载Mask图像 (mskPath)
    │               │   └── [TurboJPEG] JPEG解码 → RGB
    │               │
    │               ├── 获取BNF特征 (bnfIndex)
    │               │   └── 从PcmSession取出对应索引的BNF特征
    │               │
    │               ├── [NCNN] UNet模型推理 ⭐
    │               │   ├── 输入1: 原始帧图像 (width x height x 3)
    │               │   ├── 输入2: BNF特征向量 (20维)
    │               │   ├── 输入3: 人脸区域box (4个坐标)
    │               │   └── 输出: 驱动后的人脸图像
    │               │
    │               ├── Alpha融合
    │               │   ├── 使用Mask进行区域融合
    │               │   ├── 融合人脸区域和背景
    │               │   └── 生成最终RGB图像
    │               │
    │               ├── 输出到缓冲区
    │               │   ├── rawBuffer ← 融合后的RGB图像
    │               │   └── maskBuffer ← 处理后的Mask
    │               │
    │               └── 返回渲染结果码
    │
    ├── [如果BNF未就绪] 静默渲染
    │   └── scrfdncnn.fileload(picPath, mskPath, width, height, rawBuffer, maskBuffer, imgsize)
    │       └── [C++] 简单加载图像，不经过UNet推理
    │
    ├── 创建ImageFrame
    │   └── new ImageFrame(rawBuffer, maskBuffer, width, height)
    │
    ├── 输出到渲染器
    │   └── mRenderSink.onVideoFrame(imageFrame)
    │       └── DUIXRenderer.onVideoFrame(imageFrame)
    │           ├── 保存待渲染帧: pendingFrame = imageFrame
    │           ├── 检查分辨率变化 → 更新MVP矩阵
    │           └── glTextureView.requestRender() (请求OpenGL渲染)
    │               └── [GLThread] DUIXRenderer.onDrawFrame()
    │                   ├── GLES20.glClear() (清空缓冲区)
    │                   ├── GLES20.glEnable(GL_BLEND) (启用混合)
    │                   ├── GLES20.glBlendFuncSeparate() (设置混合函数)
    │                   └── mImageDrawer.draw(pendingFrame, mMvpMatrix)
    │                       ├── 上传RGB纹理到GPU
    │                       ├── 上传Mask纹理到GPU
    │                       ├── 应用MVP矩阵变换
    │                       ├── 执行着色器程序
    │                       └── 绘制到屏幕
    │
    ├── 性能统计
    │   └── mReporter.onRenderStat(resultCode, isLip, useTime)
    │
    └── 延迟调度下一帧
        └── delay = 40 - useTime
            └── Handler.sendMessageDelayed(MSG_RENDER_STEP, delay)
```

### 5.4 动作播放依赖链

```
动作播放流程:
用户点击动作按钮
  └── duix.startMotion(name, now)
      └── RenderThread.requireMotion(name, now)
          └── Handler发送MSG_REQUIRE_MOTION
              └── handleRequireMotion(name, now)
                  ├── 从ModelInfo中查找匹配的动作区间
                  │   └── ModelInfo.getMotionRegions()
                  │       └── 包含动作名称、起始帧、结束帧
                  │
                  ├── [now=true] 立即播放
                  │   ├── prepareActionRegion = matchRegion
                  │   └── requireMotion = true
                  │       └── [下一次renderStep]
                  │           ├── 清空播放队列
                  │           └── 加载动作区间帧到队列
                  │
                  └── [now=false] 队列末尾插入
                      └── mPreviewQueue.addAll(matchRegion.frames)

随机动作播放:
用户点击"随机动作"
  └── duix.startRandomMotion(now)
      └── RenderThread.requireRandomMotion(now)
          └── 随机选择一个动作区间
              └── 调用handleRequireMotion流程

动作帧渲染:
└── renderStep()
    ├── 从队列取帧: frame = mPreviewQueue.poll()
    │   └── ModelInfo.Frame包含:
    │       ├── rawPath (原始图像路径)
    │       ├── sgPath (可选的预处理图像路径)
    │       ├── maskPath (Mask图像路径)
    │       ├── rect (人脸区域)
    │       ├── actionName (动作名称)
    │       ├── startFlag (动作开始标志)
    │       └── endFlag (动作结束标志)
    │
    ├── [startFlag=true] 回调动作开始
    │   └── callback.onMotionPlayStart(frame.actionName)
    │       └── [UI] CallActivity收到动作开始事件
    │
    ├── 渲染帧 (fileload或filerst)
    │
    ├── [endFlag=true] 回调动作完成
    │   └── callback.onMotionPlayComplete(frame.actionName)
    │       └── [UI] CallActivity收到动作完成事件
    │
    └── [队列为空] 加载静默区间
        ├── 加载正向静默帧
        ├── 加载反向静默帧 (形成循环)
        └── 形成呼吸动作效果
```

---

## 六、数据流依赖分析

### 6.1 音频数据流

```
音频数据流转:
[输入源]
├── PCM文件 (assets/pcm/*.pcm)
├── WAV文件 (assets/wav/*.wav)
└── 录音 (AudioRecorder)

[数据格式]
├── 采样率: 16kHz
├── 位深: 16bit
├── 声道: 单声道 (MONO)
└── 每帧: 320字节 (10ms音频)

[处理流程]
PCM数据 (byte[])
  ↓ duix.pushPcm()
RenderThread (Java)
  ↓ Handler消息传递
handlePushAudio()
  ↓ JNI调用
DuixJni.cpp
  ↓ Java_ai_guiji_duix_DuixNcnn_pushpcm()
gjsimp.cpp
  ↓ dhduix_pushpcm()
PcmSession (C++)
  ↓ 累积到minblock大小
dhpcm.cpp
  ↓ PCM → MFCC特征提取
mfcc.cpp
  ↓ MFCC特征 (梅尔频率倒谱系数)
wenetai.cpp
  ↓ ONNX Runtime推理
Wenet模型 (*.onnx)
  ↓ 输出BNF特征 (20维向量)
PcmSession队列
  ↓ readycnt() > 0
RenderThread.renderStep()
  ↓ bnfIndex = audioPlayer.getPlayIndex()
scrfdncnn.filerst()
  ↓ BNF特征作为UNet输入
UNet模型推理
  ↓ 驱动人脸口型
渲染输出

[并行流程 - 音频播放]
PCM数据
  ↓ audioPlayer.pushData()
AudioFrame队列
  ↓ PlaybackThread.run()
AudioTrack.write()
  ↓ Android音频系统
扬声器输出
```

### 6.2 图像数据流

```
图像数据流转:
[模型文件]
/duix/model/{modelName}/
├── frame_*.jpg (原始帧图像)
├── mask_*.jpg (Mask图像)
└── frame_sg_*.jpg (可选的预处理帧)

[静默区间] (循环播放)
ModelInfo.silenceRegion
  ↓ frames[0...N]
  ↓ + reverse(frames)
mPreviewQueue

[动作区间] (用户触发)
ModelInfo.motionRegions[i]
  ↓ frames[start...end]
mPreviewQueue

[渲染循环]
renderStep() (每40ms)
  ↓ frame = mPreviewQueue.poll()
frame.rawPath / frame.sgPath
  ↓ scrfdncnn.fileload() 或 filerst()
  ↓ [C++] dhduix_fileinx()
JMat.loadjpg()
  ↓ TurboJPEG解码
原始图像 (width x height x 3 RGB)

[口型驱动]
+ BNF特征 (20维)
+ 人脸区域 (4个坐标)
  ↓ [NCNN] UNet模型推理
驱动后人脸图像

[融合]
+ Mask图像
  ↓ malpha.cpp (Alpha融合)
最终RGB图像
  ↓ 输出到rawBuffer
ImageFrame
  ↓ mRenderSink.onVideoFrame()
DUIXRenderer.pendingFrame

[OpenGL渲染]
onDrawFrame() (GLThread)
  ↓ rawBuffer → GL_TEXTURE_2D (RGB纹理)
  ↓ maskBuffer → GL_TEXTURE_2D (Mask纹理)
  ↓ 应用MVP矩阵 (缩放/平移)
ImageDrawer着色器程序
  ↓ 顶点着色器 + 片段着色器
  ↓ 纹理映射 + Alpha混合
GLSurfaceView显示
  ↓ EGLSurface
屏幕输出 (Activity界面)
```

### 6.3 模型文件依赖

```
模型文件结构:
/duix/model/
├── gj_dh_res/ ⭐ 基础配置 (必需)
│   ├── wenet_encoder.onnx (Wenet语音模型)
│   ├── unet.param (UNet模型结构)
│   ├── unet.bin (UNet模型权重)
│   └── unet_mask.jpg (UNet Mask模板)
│
└── {modelName}/ ⭐ 数字人模型 (必需)
    ├── model.json (模型元数据)
    │   ├── name: 模型名称
    │   ├── width: 图像宽度
    │   ├── height: 图像高度
    │   ├── hasMask: 是否有Mask
    │   ├── modelkind: 模型类型 (168等)
    │   ├── unetparam: UNet参数文件路径
    │   ├── unetbin: UNet权重文件路径
    │   ├── unetmsk: UNet Mask文件路径
    │   └── wenetfn: Wenet模型文件路径
    │
    ├── action.json (动作区间配置)
    │   ├── silenceRegion: 静默区间
    │   │   ├── start: 起始帧号
    │   │   └── end: 结束帧号
    │   │
    │   └── motionRegions: 动作区间数组
    │       └── [
    │           {
    │             name: 动作名称,
    │             start: 起始帧号,
    │             end: 结束帧号
    │           },
    │           ...
    │         ]
    │
    ├── frame_*.jpg (原始帧图像序列)
    │   └── 命名格式: frame_0001.jpg, frame_0002.jpg, ...
    │
    ├── mask_*.jpg (Mask图像序列)
    │   └── 命名格式: mask_0001.jpg, mask_0002.jpg, ...
    │
    └── [可选] frame_sg_*.jpg (预处理帧序列)
        └── 经过特殊处理的帧图像

[加载流程]
ModelInfoLoader.load()
  ├── 读取 model.json → 模型配置
  ├── 读取 action.json → 动作配置
  ├── 构建帧路径映射
  │   ├── silenceRegion.frames → 静默帧列表
  │   └── motionRegions[i].frames → 动作帧列表
  └── 返回 ModelInfo 对象
```

---

## 七、线程和并发依赖

### 7.1 线程架构

```
线程架构:
[主线程 - UI Thread]
├── Activity生命周期
├── View绘制和事件处理
├── 回调接收 (Callback.onEvent)
└── Toast和Dialog显示

[GLThread - OpenGL渲染线程]
├── GLSurfaceView管理
├── DUIXRenderer.onDrawFrame()
├── ImageDrawer着色器执行
└── EGL上下文管理

[RenderThread - 数字人渲染线程]
├── Handler消息循环 (Looper)
├── 渲染循环 (MSG_RENDER_STEP, 40ms)
├── JNI调用 (DuixNcnn)
├── AudioPlayer控制
└── 回调发送到主线程

[PlaybackThread - 音频播放线程]
├── AudioPlayer.PlaybackThread
├── 从AudioFrame队列取数据
├── AudioTrack.write()
└── 播放完成回调

[calcworker - Native音频计算线程]
├── PcmSession.runcalc()
├── MFCC特征提取
├── Wenet模型推理 (ONNX)
└── BNF特征生成

[DownloadThread - 下载线程]
├── ExecutorService.newSingleThreadExecutor()
├── FileDownloader.download()
├── ZipUtil.unzip()
└── 进度回调到主线程

[线程同步机制]
├── Handler-Looper (线程间消息传递)
├── pthread_mutex_t (Native互斥锁)
│   ├── pushmutex (音频推送锁)
│   ├── readmutex (音频读取锁)
│   └── freemutex (会话释放锁)
├── ConcurrentLinkedQueue (Java线程安全队列)
│   ├── mPlayQueue (AudioFrame队列)
│   └── mPreviewQueue (渲染帧队列)
├── std::queue (C++ STL队列)
│   └── slist (PcmSession队列)
└── volatile (原子变量)
    ├── isRendering (渲染状态)
    ├── isPlaying (播放状态)
    └── sessid (会话ID)
```

### 7.2 关键锁和队列

| 名称 | 类型 | 用途 | 位置 |
|------|------|------|------|
| pushmutex | pthread_mutex_t | 保护PCM数据推送 | dhduix_t |
| readmutex | pthread_mutex_t | 保护BNF特征读取 | dhduix_t |
| freemutex | pthread_mutex_t | 保护会话释放 | dhduix_t |
| mPlayQueue | ConcurrentLinkedQueue | 音频播放队列 | AudioPlayer |
| mPreviewQueue | ConcurrentLinkedQueue | 渲染帧队列 | RenderThread |
| slist | std::queue | 待释放会话队列 | dhduix_t |
| mReadyFence | Object | Java对象锁 | RenderThread |
| mBnfFence | Object | Java对象锁 | RenderThread |
| mPlayingFence | Object | Java对象锁 | PlaybackThread |

---

## 八、ProGuard混淆规则依赖

### 8.1 必须保留的类

```proguard
# JNI Native方法不能混淆
-keep class ai.guiji.duix.DuixNcnn {*;}

# OkHttp网络库
-dontwarn com.squareup.okhttp3.**
-keep class com.squareup.okhttp3.** {*;}

# Native方法
-keepclasseswithmembernames class * {
    native <methods>;
}

# Serializable类
-keepnames class * implements java.io.Serializable
-keepclassmembers class * implements java.io.Serializable {
    static final long serialVersionUID;
    private static final java.io.ObjectStreamField[] serialPersistentFields;
    !static !transient <fields>;
    private void writeObject(java.io.ObjectOutputStream);
    private void readObject(java.io.ObjectInputStream);
    java.lang.Object writeReplace();
    java.lang.Object readResolve();
}

# Parcelable类
-keep class * implements android.os.Parcelable {
    public static final android.os.Parcelable$Creator *;
}

# 枚举类
-keepclassmembers enum * {
    public static **[] values();
    public static ** valueOf(java.lang.String);
}

# R资源类
-keep class **.R$* {*;}

# JSON相关
-keepclassmembers class * {
   public <init> (org.json.JSONObject);
}

# 注解
-keepattributes *Annotation*

# 泛型签名
-keepattributes Signature

# 源文件和行号 (用于调试)
-keepattributes SourceFile,LineNumberTable
```

### 8.2 依赖库混淆注意事项

| 库 | 是否需要规则 | 原因 |
|----|--------------|------|
| DuixNcnn | 是 | JNI Native方法调用 |
| OkHttp | 是 | 反射和接口调用 |
| Glide | 否 | 自带混淆规则 |
| AndroidX | 否 | 自带混淆规则 |
| resource_loader.jar | 建议保留 | ModelInfo等可能被反射使用 |

---

## 九、依赖版本兼容性

### 9.1 Android版本兼容性

| 组件 | 最低版本 | 目标版本 | 兼容性说明 |
|------|----------|----------|------------|
| SDK | API 24 (Android 7.0) | API 33/34 (Android 13/14) | 完全兼容 |
| OpenGL ES | 2.0 | - | 所有Android 7.0+设备支持 |
| AudioTrack | API 24+ | - | 使用标准音频API |
| WebView | API 24+ | - | 欢迎页面使用 |
| ViewBinding | API 24+ | - | Android Studio 3.6+ |

### 9.2 NDK和工具链兼容性

| 工具 | 版本 | 说明 |
|------|------|------|
| NDK | 23.1.7779620 | 稳定版本 |
| CMake | 4.1.0 | NDK配套版本 |
| C++标准 | C++17 | 支持现代C++特性 |
| Gradle | 8.1.2 | 匹配AGP版本 |
| Kotlin | 1.8.10 | 稳定版本 |

### 9.3 第三方库版本选择

| 库 | 选择版本 | 原因 |
|----|----------|------|
| NCNN | 20231027 | 最新稳定版，性能优化 |
| OpenCV | 4.6.0 mobile | 移动端优化，体积小 |
| ONNX Runtime | - | 支持最新ONNX格式 |
| OkHttp | 4.10.0 | 稳定的HTTP/2支持 |
| Glide | 4.12.0 | 成熟的图片加载库 |

---

## 十、依赖优化建议

### 10.1 当前依赖存在的问题

1. **ModelInfo和ModelInfoLoader在JAR中**
   - 问题: 不方便查看源码和调试
   - 建议: 考虑将这些类移到源码目录

2. **Native库体积较大**
   - 问题: APK体积大 (NCNN + OpenCV + ONNX)
   - 建议:
     - 使用App Bundle动态交付
     - 考虑模型文件云端下载

3. **第三方库版本较旧**
   - 问题: androidx.appcompat:1.2.0 (test模块)
   - 建议: 统一升级到最新稳定版

4. **缺少依赖版本管理**
   - 问题: 版本号分散在各模块build.gradle中
   - 建议: 使用Gradle版本目录 (Version Catalog)

### 10.2 性能优化依赖

1. **渲染性能**
   - 当前: NCNN CPU推理
   - 优化: 考虑GPU加速 (Vulkan backend)

2. **音频处理**
   - 当前: 单线程calcworker
   - 优化: 考虑多线程并行处理

3. **图像加载**
   - 当前: 每帧都从文件加载
   - 优化: 实现LRU缓存机制

### 10.3 依赖解耦建议

1. **UI与业务逻辑分离**
   - 当前: Activity中直接调用SDK
   - 建议: 引入ViewModel层

2. **网络库统一**
   - 当前: OkHttp仅在App模块
   - 建议: SDK也使用OkHttp，统一依赖

3. **日志系统统一**
   - 当前: Native和Java各自日志
   - 建议: 统一日志接口，方便调试

---

## 十一、依赖图总览

### 11.1 模块依赖图

```
┌──────────────────────────────────────────────────────────────────┐
│                         Application层                             │
│                                                                    │
│  ┌──────────────────────────────────────────────────────────┐   │
│  │                      test (示例应用)                       │   │
│  │                                                            │   │
│  │  MainActivity → CallActivity → BaseActivity               │   │
│  │       ↓              ↓                                    │   │
│  │  UI组件         渲染界面                                  │   │
│  │  工具类         控制逻辑                                  │   │
│  │                                                            │   │
│  └───────────────────────┬──────────────────────────────────┘   │
│                          │ implementation                         │
└──────────────────────────┼────────────────────────────────────────┘
                           ↓
┌──────────────────────────────────────────────────────────────────┐
│                        SDK核心层                                  │
│                                                                    │
│  ┌──────────────────────────────────────────────────────────┐   │
│  │                  duix-sdk (核心SDK)                        │   │
│  │                                                            │   │
│  │  ┌─────────────────────────────────────────────────┐    │   │
│  │  │          Java/Kotlin API层                       │    │   │
│  │  │                                                   │    │   │
│  │  │  DUIX (主入口) → RenderThread (渲染核心)        │    │   │
│  │  │        ↓                  ↓                      │    │   │
│  │  │  VirtualModelUtil   DUIXRenderer (OpenGL)       │    │   │
│  │  │  DownloadZipService AudioPlayer (AudioTrack)    │    │   │
│  │  │  WelcomeActivity (WebView)                      │    │   │
│  │  │  WelcomeConfig (SharedPreferences)              │    │   │
│  │  └───────────────────────┬───────────────────────────┘    │   │
│  │                          │ JNI                             │   │
│  │  ┌───────────────────────↓───────────────────────────┐    │   │
│  │  │          Native (C++) 层                           │    │   │
│  │  │                                                     │    │   │
│  │  │  DuixJni.cpp (JNI接口)                            │    │   │
│  │  │       ↓                                            │    │   │
│  │  │  gjsimp.cpp (数字人核心)                          │    │   │
│  │  │       ↓              ↓              ↓              │    │   │
│  │  │  dhpcm       +    dhunet      +   dhcore          │    │   │
│  │  │  (音频)           (图像)         (数据结构)        │    │   │
│  │  └─────────────────────────────────────────────────┘    │   │
│  │                          │ 链接                            │   │
│  │  ┌───────────────────────↓───────────────────────────┐    │   │
│  │  │          第三方Native库                            │    │   │
│  │  │                                                     │    │   │
│  │  │  NCNN    OpenCV    ONNX    TurboJPEG   FFmpeg     │    │   │
│  │  │  (推理)  (视觉)    (AI)    (JPEG)      (音视频)   │    │   │
│  │  └─────────────────────────────────────────────────┘    │   │
│  │                                                            │   │
│  └────────────────────────────────────────────────────────┘   │
│                                                                    │
└──────────────────────────────────────────────────────────────────┘
                           ↑
                           │ 依赖
                           │
┌──────────────────────────────────────────────────────────────────┐
│                    Android系统层                                  │
│                                                                    │
│  Android SDK, JNI, NDK, OpenGL ES, AudioTrack, WebView, ...      │
│                                                                    │
└──────────────────────────────────────────────────────────────────┘
```

### 11.2 关键类调用链图

```
用户操作
    ↓
MainActivity (UI层)
    ↓ startActivity
CallActivity (UI层)
    ↓ 创建实例
DUIX (SDK接口层)
    ↓ init()
RenderThread (渲染控制层)
    ↓ start() → run()
DuixNcnn (JNI接口层)
    ↓ JNI调用
DuixJni.cpp (JNI实现层)
    ↓ Native函数
gjsimp.cpp (数字人核心层)
    ↓ 模型推理
┌───────────────┬───────────────┐
↓               ↓               ↓
dhpcm.cpp      munet.cpp      jmat.cpp
(音频处理)     (图像处理)     (矩阵运算)
    ↓               ↓               ↓
wenetai.cpp    NCNN API       TurboJPEG
    ↓
ONNX Runtime
    ↓
[输出] BNF特征 + 驱动后图像
    ↓
ImageFrame (数据传递层)
    ↓
DUIXRenderer (OpenGL渲染层)
    ↓
GLSurfaceView (Android渲染层)
    ↓
屏幕显示
```

---

## 十二、总结

### 12.1 核心依赖路径

1. **应用启动路径**: App → MainActivity → WelcomeActivity → CallActivity
2. **SDK初始化路径**: DUIX → RenderThread → DuixNcnn → Native库
3. **音频驱动路径**: PCM → Wenet(ONNX) → BNF → UNet(NCNN) → 渲染
4. **图像渲染路径**: Frame → TurboJPEG → UNet → Alpha融合 → OpenGL

### 12.2 关键技术栈

- **前端UI**: Kotlin + ViewBinding + WebView (欢迎页)
- **核心SDK**: Java + C++ (JNI)
- **AI推理**: NCNN (UNet) + ONNX Runtime (Wenet)
- **图像处理**: OpenCV + TurboJPEG
- **音频处理**: AudioTrack + MFCC
- **图形渲染**: OpenGL ES 2.0 + GLSurfaceView
- **网络下载**: OkHttp
- **数据存储**: SharedPreferences + 文件系统

### 12.3 依赖复杂度评估

- **模块数量**: 2个 (test + duix-sdk)
- **Java/Kotlin类数量**: 约50+个
- **C++源文件数量**: 约30+个
- **第三方库数量**: 15+个
- **JNI接口数量**: 15个Native方法
- **线程数量**: 6个 (UI, GL, Render, Playback, calcworker, Download)

### 12.4 维护建议

1. **定期更新依赖库**，特别是安全相关的库
2. **统一版本管理**，使用Gradle Version Catalog
3. **优化Native库体积**，考虑按需加载
4. **完善文档**，特别是Native代码部分
5. **增加单元测试**，特别是核心算法部分
6. **监控性能指标**，如渲染帧率、音频延迟等

---

## 附录

### A. 重要文件路径清单

#### Java/Kotlin源文件
- C:\Users\cancer\Desktop\company\code\human_android\test\src\main\java\ai\guiji\duix\test\App.java
- C:\Users\cancer\Desktop\company\code\human_android\test\src\main\java\ai\guiji\duix\test\ui\activity\MainActivity.kt
- C:\Users\cancer\Desktop\company\code\human_android\test\src\main\java\ai\guiji\duix\test\ui\activity\CallActivity.kt
- C:\Users\cancer\Desktop\company\code\human_android\test\src\main\java\ai\guiji\duix\test\ui\activity\BaseActivity.java
- C:\Users\cancer\Desktop\company\code\human_android\duix-sdk\src\main\java\ai\guiji\duix\sdk\client\DUIX.java
- C:\Users\cancer\Desktop\company\code\human_android\duix-sdk\src\main\java\ai\guiji\duix\sdk\client\thread\RenderThread.java
- C:\Users\cancer\Desktop\company\code\human_android\duix-sdk\src\main\java\ai\guiji\duix\DuixNcnn.java
- C:\Users\cancer\Desktop\company\code\human_android\duix-sdk\src\main\java\ai\guiji\duix\sdk\client\render\DUIXRenderer.java
- C:\Users\cancer\Desktop\company\code\human_android\duix-sdk\src\main\java\ai\guiji\duix\sdk\client\audio\AudioPlayer.java
- C:\Users\cancer\Desktop\company\code\human_android\duix-sdk\src\main\java\ai\guiji\duix\sdk\client\VirtualModelUtil.java
- C:\Users\cancer\Desktop\company\code\human_android\duix-sdk\src\main\java\ai\guiji\duix\sdk\welcome\WelcomeActivity.kt
- C:\Users\cancer\Desktop\company\code\human_android\duix-sdk\src\main\java\ai\guiji\duix\sdk\welcome\WelcomeConfig.kt

#### Native源文件
- C:\Users\cancer\Desktop\company\code\human_android\duix-sdk\src\main\cpp\android\DuixJni.cpp
- C:\Users\cancer\Desktop\company\code\human_android\duix-sdk\src\main\cpp\duix\gjsimp.cpp
- C:\Users\cancer\Desktop\company\code\human_android\duix-sdk\src\main\cpp\duix\gjduix.cpp
- C:\Users\cancer\Desktop\company\code\human_android\duix-sdk\src\main\cpp\include\gjsimp.h
- C:\Users\cancer\Desktop\company\code\human_android\duix-sdk\src\main\cpp\include\gjduix.h

#### 构建配置文件
- C:\Users\cancer\Desktop\company\code\human_android\build.gradle
- C:\Users\cancer\Desktop\company\code\human_android\test\build.gradle
- C:\Users\cancer\Desktop\company\code\human_android\duix-sdk\build.gradle
- C:\Users\cancer\Desktop\company\code\human_android\duix-sdk\src\main\cpp\CMakeLists.txt

#### 库文件
- C:\Users\cancer\Desktop\company\code\human_android\duix-sdk\libs\resource_loader.jar

### B. 依赖关系统计

| 类别 | 数量 |
|------|------|
| 总模块数 | 2 |
| Java类 | 23 |
| Kotlin类 | 9 |
| C++源文件 | 20 |
| C++头文件 | 150+ |
| JNI Native方法 | 15 |
| Android权限 | 2 |
| 第三方Android库 | 9 |
| 第三方Native库 | 8 |
| 静态库(.a) | 30+ |
| 动态库(.so) | 3 |

---

**报告结束**

该依赖分析报告全面覆盖了human_android项目的所有依赖关系，包括模块依赖、类依赖、Native依赖、第三方库依赖、线程依赖等。报告可作为项目维护、重构、优化的重要参考文档。
